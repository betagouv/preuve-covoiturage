openapi: 3.0.3
info:
  title: Registre de preuve de covoiturage (API)
  version: "3.1"
  termsOfService: https://doc.covoiturage.beta.gouv.fr/nos-services/le-registre-de-preuve-de-covoiturage/cgu-conditions-generales-dutilisation
  contact:
    name: √âquipe technique du RPC
    email: technique@covoiturage.beta.gouv.fr
  license:
    name: Licence Apache-2.0
    url: https://raw.githubusercontent.com/betagouv/preuve-covoiturage/main/LICENSE
  description: |
      ## Le produit

      Le Registre de preuve de covoiturage est un service num√©rique d√©velopp√©
      par le Minist√®re de la transition √©cologique et l'ADEME. Il fait partie de
      l'incubateur des Startups d'√âtat : la communaut√©
      [beta.gouv.fr](https://beta.gouv.fr/)

      ## Pour qui ?

      Cette documentation technique est destin√©e aux personnes :

      - souhaitant se connecter √† l'API pour envoyer des preuves, g√©n√©rer des attestations ;
      - souhaitant comprendre l'organisation globale de l'application ;
      - souhaitant installer, ex√©cuter, tester, modifier le code ;
      - souhaitant soumettre des correctifs ou des am√©liorations ;
      - souhaitant comprendre les m√©thodes de calcul utilis√©es pour les incitations ;
      - souhaitant effectuer des tests de s√©curit√© sur l'application ;
      - ...

      sinon, la [documentation g√©n√©rale du produit](https://doc.covoiturage.beta.gouv.fr/) est peut-√™tre pour vous.

      ## √âcosyst√®me

      Plusieurs services sont g√©r√©s par l'√©quipe du Registre de preuve de covoiturage :

      - [Le site vitrine](https://covoiturage.beta.gouv.fr/) pr√©sente le produit ;
      - [La documentation g√©n√©rale](https://doc.covoiturage.beta.gouv.fr/) ;
      - [L'application](https://app.covoiturage.beta.gouv.fr/) permet aux op√©rateurs et aux territoires de g√©rer les campagnes ;
      - [Les statistiques](https://app.covoiturage.beta.gouv.fr/stats) des chiffres cl√©s de la Startup d'√âtat ;
      - [Le statut des applications](https://status.covoiturage.beta.gouv.fr/) pour suivre les incidents et l'accessibilit√© des services ;
      - [Le g√©n√©rateur d'attestations sur l'honneur](https://attestation.covoiturage.beta.gouv.fr/) permet aux personnes qui covoiturent de produire facilement un document pour leur employeur dans le but de profiter du Forfait Mobilit√©s Durables.
      - [L'observatoire national du covoiturage](https://observatoire.covoiturage.gouv.fr/) permet de suivre l'√©volution des pratiques du covoiturage courte distance.

      ## Langues

      Cette documentation est principalement r√©dig√©e en fran√ßais afin d'√©viter
      de traduire des termes pr√©cis du langage administratif. Les parties
      relatives au code de l'application peuvent √™tre en anglais.

      ## √âdition

      Le code source de l'application est ouvert. Vous pouvez soumettre des
      corrections ou des propositions d'√©volution. Pour cela, vous devez avoir
      un compte sur la plateforme [Github](https://github.com/).

      ## Licence

      Cette documentation est sous licence
      [Apache-2.0](https://raw.githubusercontent.com/betagouv/preuve-covoiturage/main/LICENSE).  
      ¬© Minist√®re de la Transition √âcologique 2024.

servers:
  - url: https://api.covoiturage.beta.gouv.fr/v3.1
    description: Production
  - url: https://api.demo.covoiturage.beta.gouv.fr/v3.1
    description: Pr√©-production

security:
  - token: []

tags:
  - name: Trajets courte distance
    description: |
      Trajets de covoiturage de moins de 80 km.
  - name: Demandes CEE
    description: |
      > **D√©finitions :**
      > 
      > - CEE : Cr√©dits d'Economie d'Energie
      > - PNCEE : P√¥le National des Cr√©dits d'Economie d'Energie

      ## Pr√©sentation

      Dans le cadre des fiches standardis√©es et bonifi√©es pour le covoiturage
      courte et longue distance, le Registre de preuve de covoiturage met √†
      disposition des op√©rateurs de covoiturage, une API (Application
      Programming Interface permettant √† ces derniers de v√©rifier en partie
      l'√©ligibilit√© d'un dossier de demande CEE (v√©rification de l'historique et
      du d√©doublonnage) et de r√©colter des donn√©es du RPC n√©cessaires √† la bonne
      constitution du dossier avant envoi de celui-ci par l'op√©rateur de
      covoiturage au PNCEE.

      Cette API a pour but de fluidifier et de fiabiliser les demandes de
      dossier afin d'√©viter un maximum de refus de ces derniers par le PNCEE en
      cas de doublon par exemple.

      ## Ressources utiles

      - [Arr√™t√© de cr√©ation des op√©rations standardis√©es CEE covoiturage (fonctionnement non bonifi√©)](https://www.legifrance.gouv.fr/jorf/id/JORFSCTA000046374229)
      - Arr√™t√© de cr√©ation de la bonification : en cours

      ## Objectifs

      - v√©rification de l'√©ligibilit√© d'un usager √† l'op√©ration standardis√©e :
          - v√©rification de l'historique : invalidation des usagers ayant d√©j√† b√©n√©fici√© d'op√©rations sp√©cifiques 3 ans avant la r√©alisation du trajet. Comparatif sur la base des donn√©es transmises par les op√©rateurs
          - v√©rification d√©doublonnage : invalidation des usagers ayant d√©j√† b√©n√©fici√© de l'op√©ration standardis√©e quelque soit la plateforme de covoiturage utilis√©e.
      - confirmation de l'√©ligibilit√© et mise √† disposition d'√©l√©ments constitutifs du dossier de demande de prime
          - transmission des √©l√©ments suivants : journey_id; status et token (signature RPC)

      ## V√©rifier un token

      Pour v√©rifier le token, il faut disposer des informations suivantes :

      - siret de l'op√©rateur ;
      - type de trajet (short ou long) ;
      - num√©ro de permis ;
      - horodatage au format _ISO 8601 UTC_ (ex: `2022-11-22T08:54:19Z``).

      Ces informations sont utilis√©es pour former une cha√Æne de caract√®res comme
      suit `siret/type/permis/horadatage``,  
      exemple : `13002526500013/short/051227308989/2022-11-22T08:54:19Z`. Cette
      cha√Æne est hach√©e via un SHA512 et constitue le message.

      Ce message est sign√© via une cl√© RSA et peut donc √™tre v√©rifi√© avec la cl√©
      publique du Registre ci-apr√®s :

      ```
      -----BEGIN PUBLIC KEY-----
      MIICIDANBgkqhkiG9w0BAQEFAAOCAg0AMIICCAKCAgEA0m019dxJhmGl9XKCEBxl
      fgfKkmsre3KXlAkgan34k1vPyBuc1vz+3IQPuVrnEABghaSG8E7FpZ1DV913bWQ+
      0MTnnr801ZeE23wFYFlmpTfoOY7e89rvekLgB4oA1kisc28a5VAkGY+VggzGB9x+
      gWd82+LloPbzd1CgR3atNYXjPdQLqtEA1g6Pmj0eUNfSSr5SFUFlzmAhJyK0uUM4
      O/PKQFVBDqbrUU4fwhWJum6awmVc9G7OMUneOmu0wCl949U+Ek7VIstZpfmz3+JU
      4lMQ+9CU5OHR461WpyfC64cBcS9RbMflqivQGWMKoGgOBchVAB8vMn47ni66T5cV
      1SrKOe5IEbb4vEcHA5d1e5VwpCV4aoIRIQNzos/PO9rXOT3osTJV3wylQxIu2+5j
      yKDv0/mIKG+0HPt9fORA2TwqYZ0QEaBd8eCpgKHeKTZeAe15y1PKRUZuPKji1DL3
      1ceMIJY5iCvjMi5fwzD3rD20a1ttKvYRtqNFzYaVpmnxhnysSPUJp99KDZh6HO9g
      vfmzoi/adJ46P5+WEbOnfBO31+yKd6nnX4p7XM1F6vkDw6RXj9dE/SOKtfAljySO
      vMq3Z5rUJEjjZzYrnNkooqAXtzhp4Tl/i4t1n2XFS3pqu2vqjtDQ9+cRt6Fv8Wsx
      7Ul3uRRHi8Nb63mjjmRmd2MCAQM=
      -----END PUBLIC KEY-----
      ```

      ## Technique de d√©doublonnage

      Le processus de d√©doublonnage permet d'identifier les b√©n√©ficiaires
      potentiellement en double dans la base de donn√©es. Il s'appuie sur
      plusieurs crit√®res pour comparer les enregistrements et d√©terminer s'ils
      correspondent √† la m√™me personne.

      L'algorithme de d√©doublonnage fonctionne de la mani√®re suivante. Si l'un
      des champs suivants est similaire avec un enregistrement existant, la
      tentative d'enregistrement est consid√©r√© comme un doublon.

      - Permis de conduire (`driver_license`): Le num√©ro de permis de conduire est un identifiant unique qui permet de d√©doublonner les b√©n√©ficiaires avec certitude.
      - Cl√© d'identit√© (`identity_key`): Si la cl√© d'identit√© est d√©finie pour un b√©n√©ficiaire, elle est utilis√©e pour le d√©doublonner de mani√®re unique.
      - Nom tronqu√© et num√©ro de t√©l√©phone tronqu√© (`phone_trunc` & `last_name_trunc`): Cette combinaison permet de d√©tecter les b√©n√©ficiaires dont les noms et les num√©ros de t√©l√©phone sont similaires, m√™me si l'orthographe exacte peut varier. Cette combinaison n'est utilis√©e que sur les enregistrements pass√©s qui n'ont pas de cl√© d'identit√©.

      Cette correspondance est faite de mani√®re distincte sur la courte et la
      longue distance. Elle est √©galement limit√©e dans le temps √† la date de
      l'enregistrement qui a eu une correspondance en fonction de la nature de
      l'op√©ration (sp√©cifique ou standardis√©e).

  - name: Export de trajets
    description: |
      ## Schema d'export des trajets v3.0

      Les trajets sont export√©s au format XLSX (CSV √† venir).

      Le üîí indique que ces donn√©es ne sont pas pr√©sentes dans l'export Open data.

      ### Trajet

      | Colonne                     | Explications                                                                                                                                                                                                                  |
      | --------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
      | journey_id                  | Identifiant RPC d'un couple passager/conducteur                                                                                                                                                                               |
      | operator_trip_id&nbsp;üîí    | Identifiant op√©rateur permettant de regrouper plusieurs couples au sein d'un m√™me trajet                                                                                                                                      |
      | operator_journey_id&nbsp;üîí | Identifiant op√©rateur d'un couple passager/conducteur                                                                                                                                                                         |
      | operator_class              | La classe de preuve correspondant aux sp√©cifications d√©finies dans [Classes de preuve de covoiturage](https://doc.covoiturage.beta.gouv.fr/le-registre-de-preuve-de-covoiturage/classes-de-preuve-and-identite/classes-a-b-c) |
      | operator&nbsp;üîí            | Nom de l'op√©rateur                                                                                                                                                                                                            |
      | status                      | Statut du trajet pour le RPC                                                                                                                                                                                                  |

      ### Dates et heures

      | Colonne        | Explications                                                                                 |
      | -------------- | -------------------------------------------------------------------------------------------- |
      | start_datetime | Date et heure locale du d√©part au format ISO 8601 (YYYY-MM-DDThh:mm:ss). Plage de 10 minutes |
      | start_date     | Date locale du d√©part au format ISO 8601 (YYYY-MM-DD)                                        |
      | start_time     | Heure locale du d√©part au format Thh:mm:ss). Plage de 10 minutes                             |
      |                |                                                                                              |
      | end_datetime   | Date et heure locale d'arriv√©e au format ISO 8601 (YYYY-MM-DDThh:mm:ss). Plage de 10 minutes |
      | end_date       | Date locale d'arriv√©e au format ISO 8601 (YYYY-MM-DD)                                        |
      | end_time       | Heure locale d'arriv√©e au format Thh:mm:ss). Plage de 10 minutes                             |
      |                |                                                                                              |
      | duration       | Dur√©e indicative du trajet (HH:MM:SS) calcul√©e par le RPC                                    |

      > Les dates et heures sont exprim√©es dans le fuseau horaire `Europe/Paris`.

      ### Lieux

      | Colonne           | Explications                                                                                                                           |
      | ----------------- | -------------------------------------------------------------------------------------------------------------------------------------- |
      | distance          | Distance covoitur√©e en kilom√®tres (pr√©cision au m√®tre)                                                                                 |
      |                   |                                                                                                                                        |
      | start_lat         | Latitude comprise entre 90deg et -90deg d√©cimaux en datum WSG-84 Pr√©cision √† 3 d√©cimales zone dense et 2 d√©cimales en zone peu dense   |
      | start_lon         | Longitude comprise entre 180deg et -90deg d√©cimaux en datum WSG-84 Pr√©cision √† 3 d√©cimales zone dense et 2 d√©cimales en zone peu dense |
      | end_lat           | Latitude comprise entre 90deg et -90deg d√©cimaux en datum WSG-84 Pr√©cision √† 3 d√©cimales zone dense et 2 d√©cimales en zone peu dense   |
      | end_lon           | Longitude comprise entre 180deg et -90deg d√©cimaux en datum WSG-84 Pr√©cision √† 3 d√©cimales zone dense et 2 d√©cimales en zone peu dense |
      |                   |                                                                                                                                        |
      | start_insee       | Code INSEE commune ou arrondissement de la position de d√©part                                                                          |
      | start_commune     | Nom commune de d√©part                                                                                                                  |
      | start_departement | Nom du d√©partement de la position de d√©part                                                                                            |
      | start_epci        | EPCI de d√©part                                                                                                                         |
      | start_aom         | AOM de d√©part                                                                                                                          |
      | start_region      | Nom de la r√©gion de d√©part                                                                                                             |
      | start_pays        | Nom du pays de d√©part                                                                                                                  |
      | end_insee         | Code INSEE commune ou arrondissement de la position d'arriv√©e                                                                          |
      | end_commune       | Nom commune d'arriv√©e                                                                                                                  |
      | end_departement   | Nom du d√©partement de la position d'arriv√©e                                                                                            |
      | end_epci          | EPCI d'arriv√©e                                                                                                                         |
      | end_aom           | AOM d'arriv√©e                                                                                                                          |
      | end_region        | Nom de la r√©gion d'arriv√©e                                                                                                             |
      | end_pays          | Nom du pays d'arriv√©e                                                                                                                  |

      ### Participants

      | Colonne                        | Explications                                                  |
      | ------------------------------ | ------------------------------------------------------------- |
      | passenger_seats                | Nombre de si√®ges r√©serv√©s par l'occupant passager. D√©faut : 1 |
      |                                |                                                               |
      | operator_passenger_id&nbsp;üîí  | identifiant op√©rateur du passager                             |
      | passenger_identity_key&nbsp;üîí | identifiant unique inter-op√©rateur du passager                |
      | operator_driver_id&nbsp;üîí     | identifiant op√©rateur du conducteur                           |
      | driver_identity_key&nbsp;üîí    | identifiant unique inter-op√©rateur du conducteur              |

      ### Subventions

      | Colonne                           | Explications                                                                                                                                                                                                                                          |
      | --------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
      | cee_application                   | Lien avec un dossier CEE (Oui/Non)                                                                                                                                                                                                                    |
      |                                   |                                                                                                                                                                                                                                                       |
      | driver_revenue&nbsp;üîí            | La somme en ‚Ç¨ r√©ellement per√ßue par le conducteur APR√àS que toutes les incitations (subventions employeurs, promotions op√©rateurs, incitations AOM, etc.), contributions des passagers ont √©t√© vers√©es et que la commission de l'op√©rateur soit prise |
      | passenger_contribution&nbsp;üîí    | Co√ªt r√©el total en ‚Ç¨ du service pour l'occupant passager en fonction du nombre de si√®ges r√©serv√©s APR√àS que toutes les possibles incitations ont √©t√© vers√©es (subventions employeurs, promotions op√©rateurs, incitations AOM, etc)                    |
      | incentive_type                    | P√©riode "normale" ou "booster"                                                                                                                                                                                                                        |
      | incentive\_{N}\_siret             | SIRET de la contrepartie financi√®re N                                                                                                                                                                                                                 |
      | incentive\_{N}\_name              | Organisme distributeur                                                                                                                                                                                                                                |
      | incentive\_{N}\_amount            | Montant en ‚Ç¨ de la contrepartie financi√®re N                                                                                                                                                                                                          |
      | incentive_rpc\_{N}\_campaign_id   | ID de la campagne de la contrepartie financi√®re N calcul√©e par le RPC                                                                                                                                                                                 |
      | incentive_rpc\_{N}\_campaign_name | Nom de la campagne de la contrepartie financi√®re N calcul√©e par le RPC                                                                                                                                                                                |
      | incentive_rpc\_{N}\_siret         | SIRET du sponsor de la contrepartie financi√®re N calcul√©e par le RPC                                                                                                                                                                                  |
      | incentive_rpc\_{N}\_name          | Nom du sponsor de la contrepartie financi√®re N calcul√©e par le RPC                                                                                                                                                                                    |
      | incentive_rpc\_{N}\_amount        | Montant en ‚Ç¨ de la contrepartie financi√®re N calcul√©e par le RPC                                                                                                                                                                                      |

      ## Comparatif V2.0 / V3.0

      Tableau comparatif des colonnes entre les versions 2 et 3 de l'export des
      trajets.

      | V2.0                             | V3.0                          | Remarques sur la migration V2 -> V3                                            |
      | -------------------------------- | ----------------------------- | ------------------------------------------------------------------------------ |
      | journey_id                       | journey_id                    | Identifiant unique de couple passager/conducteur                               |
      | trip_id                          |                               | Identifiant de regroupement des couples g√©n√©r√© par le RPC                      |
      |                                  | operator_trip_id              | Identifiant de regroupement des couples g√©n√©r√© par l'op√©rateur                 |
      |                                  | operator_journey_id           | Identifiant de couple g√©n√©r√© par l'op√©rateur                                   |
      | journey_start_datetime           | start_datetime                | Passage en UTC                                                                 |
      | journey_start_date               | start_date                    | Passage en UTC                                                                 |
      | journey_start_time               | start_time                    | Passage en UTC                                                                 |
      | journey_start_lon                | start_lon                     |                                                                                |
      | journey_start_lat                | start_lat                     |                                                                                |
      | journey_start_insee              | start_insee                   |                                                                                |
      | journey_start_department         | start_departement             |                                                                                |
      | journey_start_town               | start_commune                 |                                                                                |
      | journey_start_towngroup          | start_epci                    |                                                                                |
      | journey_start_country            | start_pays                    |                                                                                |
      | journey_end_datetime             | end_datetime                  | Passage en UTC                                                                 |
      | journey_end_date                 | end_date                      | Passage en UTC                                                                 |
      | journey_end_time                 | end_time                      | Passage en UTC                                                                 |
      | journey_end_lon                  | end_lon                       |                                                                                |
      | journey_end_lat                  | end_lat                       |                                                                                |
      | journey_end_insee                | end_insee                     |                                                                                |
      | journey_end_department           | end_departement               |                                                                                |
      | journey_end_town                 | end_commune                   |                                                                                |
      | journey_end_towngroup            | end_epci                      |                                                                                |
      | journey_end_country              | end_pays                      |                                                                                |
      | driver_card                      |                               |                                                                                |
      | passenger_card                   |                               |                                                                                |
      | passenger_over_18                |                               |                                                                                |
      | passenger_seats                  | passenger_seats               |                                                                                |
      | operator_class                   | operator_class                |                                                                                |
      | operator                         | operator                      |                                                                                |
      | journey_distance_anounced        | distance                      | La distance envoy√©e par l'op√©rateur. Changement de format (m -> km)            |
      | journey_distance_calculated      |                               |                                                                                |
      | journey_duration_anounced        |                               |                                                                                |
      | journey_duration_calculated      | duration                      | La dur√©e indicative calcul√©e par le RPC. Changement de format (MM -> HH:MM:SS) |
      | operator_passenger_id            | operator_passenger_id         |                                                                                |
      |                                  | passenger_identity_id         | Identifiant personnel inter-op√©rateurs                                         |
      | operator_driver_id               | operator_driver_id            |                                                                                |
      |                                  | driver_identity_key           | Identifiant personnel inter-op√©rateurs                                         |
      | status                           | status                        | Statut du trajet : `acquisition_error`, `validation_error`, `normalization_error`, `fraud_error`, `anomaly_error`, `ok`, `expired`, `canceled`, `pending`, `unknown`                                                        |
      | passenger_id                     |                               |                                                                                |
      | passenger_contribution           | passenger_contribution        |                                                                                |
      | passenger_incentive_N_siret      |                               |                                                                                |
      | passenger_incentive_N_amount     |                               |                                                                                |
      | passenger_incentive_rpc_N_siret  |                               |                                                                                |
      | passenger_incentive_rpc_N_name   |                               |                                                                                |
      | passenger_incentive_rpc_N_amount |                               |                                                                                |
      | driver_id                        |                               |                                                                                |
      | driver_revenue                   | driver_revenue                |                                                                                |
      | driver_incentive_N_siret         |                               |                                                                                |
      | driver_incentive_N_amount        |                               |                                                                                |
      | driver_incentive_rpc_N_siret     |                               |                                                                                |
      | driver_incentive_rpc_N_name      |                               |                                                                                |
      | driver_incentive_rpc_N_amount    |                               |                                                                                |
      |                                  | cee_application               | Demande de dossier CEE (oui/non)                                               |
      |                                  | incentive_type                | Type d'incitation (normale/booster)                                            |
      |                                  | incentive_N_siret             | Incitation envoy√©e par l'op√©rateur : SIRET                                     |
      |                                  | incentive_N_name              | Incitation envoy√©e par l'op√©rateur : nom                                       |
      |                                  | incentive_N_amount            | Incitation envoy√©e par l'op√©rateur : montant en ‚Ç¨                              |
      |                                  | incentive_rpc_N_campaign_id   | Incitation calcul√©e par le RPC : identifiant campagne                          |
      |                                  | incentive_rpc_N_campaign_name | Incitation calcul√©e par le RPC : nom de la campagne                            |
      |                                  | incentive_rpc_N_siret         | Incitation calcul√©e par le RPC : SIRET du sponsor                              |
      |                                  | incentive_rpc_N_name          | Incitation calcul√©e par le RPC : nom du sponsor                                |
      |                                  | incentive_rpc_N_amount        | Incitation calcul√©e par le RPC : montant en ‚Ç¨                                  |

  - name: Campagnes
    description: |
      Campagnes de covoiturage.
  - name: Attestations op√©rateurs (d√©pr√©ci√©)
    description: |
      Attestations des op√©rateurs de covoiturage.
  - name: G√©ographie
    description: |
      Requ√™tes g√©ographiques.

x-topics:
  - title: Acc√®s √† l'API
    content: |
      Envoyer un trajet de covoiturage √† l'API du Registre de Preuve de Covoiturage n√©cessite que plusieurs crit√®res soient remplis.

      1. Une entit√© ‚Äú**op√©rateur de covoiturage**‚Äù est cr√©√©e sur l'application du registre.
      2. Un utilisateur appartenant √† cet op√©rateur de covoiturage est **administrateur**.
      3. L'administrateur op√©rateur **cr√©e un token applicatif**.
      4. Ce token applicatif est **install√© sur le serveur de l'op√©rateur** qui va envoyer les donn√©es et sera pass√© dans le *Header* de chacune des requ√™tes.

  - title: Acc√©der √† l'application du Registre
    content: |
      Afin de valider les crit√®res 1 et 2 , veuillez contacter [l'√©quipe du
      Registre](mailto:contact@covoiturage.beta.gouv.fr) qui vous ouvrira un
      acc√®s √† l'application.

  - title: Cr√©er un token applicatif
    content: |
      Cette manipulation est r√©alisable, uniquement pour les utilisateurs dits
      *administrateurs*, sur l'interface applicative du Registre de preuve de
      covoiturage.

      1. Cr√©er un nouveau token ;
      2. Donner un nom √† ce token ;
      3. Copier le token g√©n√©r√© et le conserver de mani√®re s√©curis√©e. **Il devra √™tre envoy√© dans le header de chaque requ√™te serveur.**

      > ‚ö†Ô∏è Ce token ne pourra pas √™tre r√©-affich√© ni r√©cup√©r√©. Si le token est perdu, il doit √™tre recr√©√© par la m√™me proc√©dure.

  - title: Rate limiting
    content: |
      Nous appliquons une limite au nombre de requ√™tes HTTP qui peuvent
      √™tre effectu√©es dans une p√©riode donn√©e. Lorsque cette limite est
      atteinte, notre API renverra une erreur `429 Too Many Requests`.

      Chaque type de route a une limite de requ√™tes diff√©rente. La limite
      pour l'envoi des trajets est de 20000 requ√™tes par minute.

      Les en-t√™tes suivants sont envoy√©s avec chaque r√©ponse :

      - `RateLimit-Limit` : nombre total de requ√™tes entre deux r√©initialisations de quota ;
      - `RateLimit-Remaining` : nombre de requ√™tes jusqu'√† la r√©initialisation du quota ;
      - `RateLimit-Reset` : temps restant (en secondes) jusqu'√† la r√©initialisation du quota.

  - title: D√©finitions
    content: |
      Acronymes utilis√©s dans la documentation :
      
      - **RPC** : Registre de preuve de covoiturage
      - **CEE** : Cr√©dits d'Economie d'Energie
      - **PNCEE** : P√¥le National des Cr√©dits d'Economie d'Energie
      - **SIRET** : Syst√®me d'Identification du R√©pertoire des √âtablissements
      - **EPCI** : √âtablissement Public de Coop√©ration Intercommunale
      - **AOM** : Autorit√© Organisatrice de la Mobilit√©

      Concepts utilis√©s :

      - **Op√©rateur de covoiturage** : entit√© qui propose un service de covoiturage
      - **Territoire** : entit√© qui propose des campagnes de covoiturage (AOM, EPCI, ...)
      - **Trajet** : d√©placement effectu√© par un conducteur et un passager
                    (on parle aussi de couple conducteur/passager)
      - **Journey ID** : identifiant unique d'un trajet assign√© par le RPC
      - **Operator Journey ID** : identifiant unique d'un trajet assign√© par l'op√©rateur

components:
  securitySchemes:
    token:
      type: http
      scheme: bearer
      bearerFormat: JWT
  
  schemas:
    offset:
      type: number
      multipleOf: 1
      minimum: 0
      description: Offset
    total:
      type: number
      multipleOf: 1
      minimum: 0
      description: Limite
    limit:
      type: number
      multipleOf: 1
      minimum: 0
      description: Limite
    pagination:
      type: object
      required:
        - offset
        - limit
      additionalProperties: false
      properties:
        offset:
          '$ref': '#/components/schemas/offset'
        limit:
          '$ref': '#/components/schemas/limit'
        total:
          '$ref': '#/components/schemas/total'
    operator_trip_id:
      type: string
      description: Identifiant g√©n√©r√© par l'op√©rateur pour regrouper des trajets (plusieurs passagers avec un m√™me conducteur)
    operator_class:
      enum:
        - A
        - B
        - C
      description: classe de preuve correspondant aux sp√©cifications d√©finies dans [Classes de preuve de covoiturage](https://doc.covoiturage.beta.gouv.fr/le-registre-de-preuve-de-covoiturage/classes-de-preuve-and-identite/classes-a-b-c).
    licence_plate:
      type: string
      description: Plaque d'immatriculation du v√©hicule
    driver:
      type: object
      additionalProperties: false
      required:
        - identity
        - revenue
      properties:
        identity:
          '$ref': '#/components/schemas/identity'
        revenue:
          type: number
          minimum: 0
          multipleOf: 1
          description: |
            La somme r√©ellement per√ßue par le conducteur **APR√àS** que toutes les incitations (subventions employeurs, promotions op√©rateurs, incitations AOM, etc.), contributions des passagers aient √©t√© vers√©es et que la commission de l'op√©rateur soit prise.
            Somme exprim√©e en centimes.
    passenger:
      type: object
      additionalProperties: false
      required:
        - identity
        - contribution
      properties:
        identity:
          '$ref': '#/components/schemas/identity'
        payments:
          '$ref': '#/components/schemas/payments'
        contribution:
          type: number
          minimum: 0
          multipleOf: 1
          description: |
            Co√ªt r√©el total du service pour l'occupant passager en fonction du nombre de si√®ges r√©serv√©s **APR√àS** que toutes les possibles incitations aient √©t√© vers√©es (subventions employeurs, promotions op√©rateurs, incitations AOM, etc).|
            Somme exprim√©e en centimes.
        seats:
          type: number
          minimum: 1
          maximum: 8
          multipleOf: 1
          default: 1
          description: Nombre de si√®ges r√©serv√©s par l'occupant passager.
    operator_journey_id:
      type: string
      description: Identifiant unique du trajet envoy√© par l'op√©rateur. Attention, cela correspond au `journey_id` de la version 2 de l'API.
      pattern: ^[a-z0-9]{1,256}$
      minLength: 1
      maxLength: 256
    status:
      type: string
      enum:
        - fraud_error
        - anomaly_error
        - validation_error
        - acquisition_error
        - normalization_error
        - ok
        - canceled
        - pending
        - unknown
        - terms_violation_error
      description: |
        Statut du trajet tel que :
          - validation_error : les donn√©es envoy√©es ne sont pas valides
          - anomaly_error : le trajet est incoh√©rent ou physiquement impossible
          - acquisition_error : le trajet n'a pas du tout √©t√© enregistr√©
          - normalization_error : le trajet a √©t√© enregistr√© mais les donn√©es envoy√©es n'ont pas pu √™tre standardis√©e.
          - fraud_error : le trajet a √©t√© enregistr√© et standardis√© mais il a √©t√© consid√©r√© comme frauduleux
          - ok : le trajet a correctement √©t√© trait√©
          - pending : le trajet a √©t√© enregistr√© mais n'a pas encore √©t√© trait√©
          - canceled : le trajet a √©t√© annul√© par l'op√©rateur
          - unknown : une erreur inconnue a affect√© le trajet
          - terms_violation_error : le trajet ne respecte pas les conditions g√©n√©rales d'utilisation
    duration:
      type: number
      minimum: 0
      multipleOf: 1
      maximum: 36000
      description: Dur√©e exprim√©e en seconde
    distance:
      type: number
      minimum: 0
      multipleOf: 1
      maximum: 1000000
      description: Distance exprim√©e en m√®tre
    incentives:
      type: array
      description: |
        Tableau reprenant la liste compl√®te des incitations appliqu√©es (ordre d'application, montant, identifiant de l'incitateur). Si aucune incitation, envoyer un tableau vide.

        ## Ordre par d√©faut
        Par d√©faut, l'ordre d'application des politiques incitatives est le suivant :
        1. Territoire (AOM, R√©gion, ...)
        2. Sponsors (incitations employeur, CE, etc.)
        3. Op√©rateur (op√©ration promotionnelle, offres, etc.)
      items:
        type: object
        additionalProperties: false
        required:
          - index
          - amount
          - siret
        properties:
          index:
            type: number
            minimum: 0
            multipleOf: 1
            description: Ordre d'application de l'incitation
            example: 0
          amount:
            type: number
            minimum: 0
            multipleOf: 1
            description: Montant de l'incitation en centimes d'euros
            example: 100
          siret:
            type: string
            description: |
              Num√©ro de SIRET de l'incitateur
              Le SIRET est un identifiant unique par structure juridique. Toutes les entit√©s incitatrices en poss√®dent un.
            example: "11000101300017"
    payments:
      type: array
      description: |
        Z√©ro, une ou plusieurs m√©thodes de paiement utilis√©es (ex. carte employeur pr√©charg√©e permettant de payer directement le covoiturage sur une application).
        ### Tip
        La prise en charge des frais de transports personnel (carburant et forfait mobilit√©) pourra prendre la forme d'une solution de paiement sp√©cifique, d√©mat√©rialis√©e et pr√©pay√©e, intitul√©e ¬´ titre-mobilit√© ¬ª. Ainsi, il appara√Æt comme pertinent de d√©tailler la solution de paiement utilis√©e dans le cadre d'un trajet covoitur√©, s'il s'agit de Titre-Mobilit√©.
      items:
        type: object
        additionalProperties: false
        required:
          - index
          - siret
          - type
          - amount
        properties:
          index:
            type: number
            minimum: 0
            multipleOf: 1
            description: Ordre d'application
            example: 0
          amount:
            type: number
            minimum: 0
            multipleOf: 1
            description: Montant du paiement en centimes d'euros
            example: 100
          siret:
            type: string
            description: Num√©ro de SIRET du payeur
            example: "11000101300017"
          type:
            type: string
            description: Nom du titre
    lat:
      type: number
      description: Latitude comprise entre 90deg et -90deg d√©cimaux en datum WSG-84
      example: 47.682821
    lon:
      type: number
      description: Longitude comprise entre 180deg et -180deg d√©cimaux en datum WSG-84
      example: -0.557483
    geopoint:
      type: object
      additionalProperties: false
      description: |
        Position lat/lon
      required:
        - lat
        - lon
      properties:
        lat:
          '$ref': "#/components/schemas/lat"
        lon:
          '$ref': "#/components/schemas/lon"
    geo_selector:
      type: object
      minProperties: 0
      maxProperties: 8
      additionalProperties: false
      description: S√©lecteur g√©ographique par d√©coupage administratif
      properties:
        arr:
          type: array
          items:
            type: string
            description: Code consolid√© de la zone g√©ographique
        com:
          type: array
          items:
            type: string
            description: Code INSEE de la commune
        epci:
          type: array
          items:
            type: string
            description: Code INSEE de l'EPCI
        aom:
          type: array
          items:
            type: string
            description: SIRET de l'AOM
        reg:
          type: array
          items:
            type: string
            description: SIRET de la r√©gion
        dep:
          type: array
          items:
            type: string
            description: Code INSEE du d√©partement
      example:
        aom: ["200067652"]
    datetime:
      type: string
      format: date-time
      description: |
        Date et heure du d√©part/arriv√©e du passager au format ISO 8601. L'heure est exprim√©e en UTC (YYYY-MM-DDThh:mm:ssZ)
        L'heure est exprim√©e en UTC \(Coordinated Universal Time\). UTC n'est pas ajust√© sur l'heure d'√©t√© et hiver !
      example: '2021-01-01T11:00:00Z'
    time_geopoint:
      type: object
      additionalProperties: false
      description: |
        Position lat/lon + date  du passager
      required:
        - datetime
        - lat
        - lon
      properties:
        datetime:
          '$ref': "#/components/schemas/datetime"
        lat:
          '$ref': "#/components/schemas/lat"
        lon:
          '$ref': "#/components/schemas/lon"
    identity:
      type: object
      description: |
        Ces donn√©es personnelles permettent d'identifier la personne effectuant le covoiturage afin de pouvoir comptabiliser ses trajets et lui distribuer des incitations en fonction des politiques applicables.
        Deux options sont disponibles pour la transmission du num√©ro de t√©l√©phone :
        - Num√©ro complet au format ITU E.164 (phone) (ex. +33601020304, +590690101010)
        - Num√©ro au format ITU E.164 tronqu√© des 2 derniers chiffres (phone_trunc) (ex. +336010203, +5906901010) + identifiant unique de l'op√©rateur (operator_user_id)
      additionalProperties: false
      required:
        - operator_user_id
        - identity_key
        - phone_trunc
      properties:
        identity_key:
          '$ref': '#/components/schemas/identity_key'
        travel_pass:
          '$ref': '#/components/schemas/travel_pass'
        phone: 
          '$ref': '#/components/schemas/phone'
        phone_trunc:
          '$ref': '#/components/schemas/phone_trunc'
        application_timestamp:
          '$ref': '#/components/schemas/application_timestamp'
        driving_license:
          '$ref': '#/components/schemas/driving_license'
        operator_user_id:
          '$ref': '#/components/schemas/operator_user_id'
        over_18:
          '$ref': '#/components/schemas/over_18'
    identity_key:
      type: string
      minLength: 64
      maxLength: 64
      description: |
        Correspond au SHA d'une cha√Æne concat√©n√©e tel que : `sha256({phone_number}-{last_name})` o√π :
        
        - `phone_number` correspond au num√©ro de t√©l√©phone complet au format international sans espace ni tiret. Exemple : `+33601020304`
        - `last_name` correspond au nom de famille complet en majuscule, sans accent ni tiret ni apostrophe :  
           Regexp: `[A-Z ]*`  
           Exemple, M. D'H√©r√ªg-de-l'H√©rault ayant le num√©ro 07 01 02 03 04 doit √™tre formatt√© comme suit `+33701020304-D HERUG DE L HERAULT`
    travel_pass:
      type: object
      description: |
        Num√©ro de carte de transport (TCL, Navigo, Trabool, etc.) de l'occupant.
        Obligatoire si l'information est disponible.
        Actuellement support√©: navigo
      additionalProperties: false
      required:
        - name
        - user_id
      properties:
        name:
          enum:
            - navigo
          description: Nom du titre
          example: navigo
        user_id:
          type: string
          description: Num√©ro de carte de transport
          example: 00-MFR-6782929
    phone:
      type: string
      description: Num√©ro au format ITU E.164
      example: '+33601020304, +590690101010'
    phone_trunc:
      type: string
      pattern: ^\+[0-9]{8,12}$
      minLength: 10
      maxLength: 14
      description: Num√©ro de t√©l√©phone au format ITU-T E.164 tronqu√© des 2 derniers chiffres
      example: '+336010203'
    last_name_trunc:
      type: string
      pattern: ^[A-Z ]{3}$
      minLength: 3
      maxLength: 3
      description: |
        Correspond aux trois premi√®rs caract√®res du nom de famille complet en majuscule, sans accent ni tiret ni apostrophe. Dans le cas o√π le nom comporterait moins de 3 lettres, compl√©ter avec des espaces.
        Ex 1: M. D'H√©r√ªg-de-l'H√©rault => "D H"
        Ex 2: M. T√¥ => "TO "
    
    application_timestamp:
      type: string
      format: datetime
      description: Date de signature de l'engagement par le demandeur.
    driving_license:
        description: |
          Num√©ro de permis de conduire (√©galement appel√© code driving_license)
          cf https://permisdeconduire.ants.gouv.fr/tout-savoir-sur-le-permis/le-numero-de-dossier-sur-un-permis-au-format-carte-bancaire
        oneOf:
          - type: string
            description: Num√©ro de permis de conduire compos√© de 12 chiffres apr√®s 1975.
            example: '051227308989'
            pattern: ^[0-9]{12}$
            minLength: 12
            maxLength: 12
          - type: string
            description: Num√©ro de permis de conduire compos√© de 1 √† 15 caract√®res suivis de 4 chiffres avant 1975.
            example: '822146819'
            pattern: ^[A-Z0-9]{1,15}[0-9]{4}$
            minLength: 5
            maxLength: 19
          - type: string
            description: Num√©ro de permis de conduire plus anciens compos√© de 1 √† 15 caract√®res.
            example: '123456A'
            pattern: ^[A-Z0-9]{1,15}$
            minLength: 1
            maxLength: 15
          - type: string
            description: Num√©ro de permis √©tranger pr√©fix√© de l'indicatif '99-'.
            example: '99-X23836'
            pattern: ^99-.*$
            minLength: 4
            maxLength: 64
    operator_user_id:
      type: string
      description: Identifiant de l'utilisateur chez l'op√©rateur. Obligatoire.
      example: "d2e8a6c4-9e3a-4b6f-8e8d-9f7a6b5c4d3e"
    over_18:
      enum:
        - true
        - false
        - null
      description: |
        Applicable seulement au passager.
          - true si majeur
          - false si mineur
          - null si non fourni

        > De nombreuses campagnes utilisent cette information pour s'assurer que les b√©n√©ficiaires d'incitations sont majeures. La valeur `NULL` les exclues.

    journey_type:
      type: string
      enum: ['short', 'long']
    
    long_distance_application:
      type: object
      additionalProperties: false
      required:
        - journey_type
        - identity_key
        - driving_license
        - last_name_trunc
        - phone_trunc
        - datetime
        - application_timestamp
      properties:
        journey_type:
          type: string
          enum: ['long']
        identity_key:
          '$ref': '#/components/schemas/identity_key'
        driving_license:
          '$ref': '#/components/schemas/driving_license'
        last_name_trunc:
          '$ref': '#/components/schemas/last_name_trunc'
        phone_trunc:
          '$ref': '#/components/schemas/phone_trunc'
        datetime:
          type: string
          format: datetime
          description: Date de partage des frais.
        application_timestamp:
          '$ref': '#/components/schemas/application_timestamp'
    short_distance_application:
      type: object
      additionalProperties: false
      required:
        - journey_type
        - identity_key
        - driving_license
        - last_name_trunc
        - operator_journey_id
        - application_timestamp
      properties:
        journey_type:
          type: string
          enum: ['short']
        identity_key:
          '$ref': '#/components/schemas/identity_key'
        driving_license:
          '$ref': '#/components/schemas/driving_license'
        last_name_trunc:
          '$ref': '#/components/schemas/last_name_trunc'
        operator_journey_id:
          '$ref': '#/components/schemas/operator_journey_id'
        application_timestamp:
          '$ref': '#/components/schemas/application_timestamp'
    identitycert:
      type: object
      description: |
        L'identit√© peut √™tre pass√©e de 3 mani√®res diff√©rentes :
        1. `phone` : le num√©ro de t√©l√©phone complet au format ISO
        2. `phone_trunc` + `operator_user_id` : le num√©ro de t√©l√©phone tronqu√© plus votre identifiant utilisateur
        3. `operator_user_id` : votre identifiant utilisateur uniquement (valable uniquement si vous avez transmis des trajets avec le couple `phone_trunc` + `operator_user_id`)
      additionalProperties: false
      properties:
        phone:
          type: string
          description: Num√©ro au format ITU E.164
          example: '+33601020304, +590690101010'
        phone_trunc:
          type: string
          description: Num√©ro au format ITU E.164 tronqu√© des 2 derniers chiffres. Obligatoire si `phone` n'est pas renseign√©.
          example: '+336010203, +5906901010'
        operator_user_id:
          type: string
          description: Identifiant de l'utilisateur chez l'op√©rateur. Obligatoire.
          example: "d2e8a6c4-9e3a-4b6f-8e8d-9f7a6b5c4d3e"
    certificate_data:
      type: object
      additionalProperties: false
      properties:
        total:
          type: object
          properties:
            trips:
              type: integer
            week_trips:
              type: integer
            weekend_trips:
              type: integer
            distance:
              '$ref': '#/components/schemas/distance'
            amount:
              type: number
              description: montant en centimes d'euros
        trips:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum:
                  - driver
                  - passenger
              datetime:
                type: string
                format: date-time
              trips:
                type: integer
              distance:
                '$ref': '#/components/schemas/distance'
              amount:
                type: number
                description: montant en centimes d'euros
    terms_violation_label:
      type: string
      enum:
        - distance_too_short
        - too_many_trips_by_day
        - too_close_trips
        - expired
      description: |
        Etiquette possible pour un cas de non respect des CGU :
          - `distance_too_short` : le trajet a une distance trop faible (<2 km)
          - `too_many_trips_by_day` : le participant (driver_identity_key ou passenger_identity_key) a fait plus de 4 trajets dans la m√™me journ√©e (4 operator_trip_id maximum par usager et par jour sur la m√™me date de d√©part)
          - `too_close_trips` : le trajet est trop rapproch√© d'un trajet pr√©c√©dent ou suivant r√©alis√© avec la m√™me personne (D√©lai minimum de 30mn entre 2 trajets (operator_trip_id diff√©rent) impliquant un m√™me usager (driver_identity_key ou passenger_identity_key). Sont pris en compte les trajets finissant moins de 30 min avant le d√©part du trajet soumis ou d√©marrant moins de 30 min apr√®s la fin du trajet soumis.
          - `expired` : le trajet a d√©pass√© la date limite d'envoi de 24h apr√®s la date de d√©but du trajet. [Cf: engagement de d√©lais d'envoi par les op√©rateurs](https://doc.covoiturage.beta.gouv.fr/bienvenue/faq-foire-aux-questions#quel-est-le-delai-denvoi-des-preuves-de-covoiturage)
    fraudcheck_label:
      type: string
      enum:
        - interoperator_overlap
        - interoperator_too_many_trips_by_day
        - interoperator_too_close_trips
      description: |
        Etiquette possible pour un cas de fraude d√©tect√©e :
          - `interoperator_overlap` : le trajet a √©t√© d√©clar√© chez un autre op√©rateur pour les m√™mes personnes et avec des bornes temporelles qui se chevauchent. (anciennement `interoperator_fraud`) 
          - `interoperator_too_many_trips_by_day` : le participant (`identity_key`) a fait plus de 4 trajets sur des op√©rateurs diff√©rents dans la m√™me journ√©e.
          - `interoperator_too_close_trips` : le trajet d'un couple d'`identity_key` (passager/ conducteur) est trop rapproch√© (inf√©rieur √† 30 min) d'un trajet pr√©c√©dent impliquant ce m√™me couple sur un autre op√©rateur.    
    anomaly_label:
      type: string
      enum:
        - temporal_overlap_anomaly
        - distance_duration_anomaly
      description: |
        # Etiquette possible pour une anomalie d√©tect√©e
          - `temporal_overlap_anomaly` : 2 trajets ont √©t√© d√©clar√©s pour un m√™me op√©rateur et un m√™me passager sur des bornes temporelles qui se chevauchent √† au moins 70%
          - `distance_duration_anomaly`: 1 trajet a √©t√© enregistr√© avec une dur√©e et/ou une distance incoh√©rente

        ## R√®gles utilis√©es pour detecter les anomalies de type `distance_duration_anomaly`

         - distance estim√©e par osrm ou transmises inf√©rieure √† 300m.
         Le trajet est beaucoup trop court en termes de distance.
         - dur√©e estim√©e par osrm ou transmise inf√©rieure √† 1 minute.
         Le trajet est beaucoup trop court en termes de dur√©e
         - dur√©e estim√©e par osrm sup√©rieure √† 2.5 fois le temps transmis. Exemple: temps estim√© 25 minutes pour temps transmis de 10 minutes
         Le temps de trajet est trop faible par rapport au plus court chemin determin√© par OSRM, le trajet est consid√©r√© comme physiquement impossible
         - distance estim√©e par osrm sup√©rieure √† 2.5 fois la distance transmise. Exemple: distance 10 km sur une distance estim√©e 25 km
         La distance du trajet est trop faible par rapport au plus court chemin determin√© par OSRM, le trajet est consid√©r√© comme physiquement impossible
         - distance transmise sup√©rieure √† 4 fois la distance estim√©e osrm. Exemple: 10 km estim√© pour 40 km transmis
         La distance transmise est tr√®s largement sup√©rieure √† l'estimation. Le seuil est √©lev√© pour prendre en compte d'√©ventuels d√©tours par rapport au plus court chemin
         - dur√©e transmise sup√©rieure √† 7 fois la dur√©e estim√©e. Exemple : 1h estim√© vs 7h transmis
         La dur√©e transmise est tr√®s largement sup√©rieure par rapport √† l'estimation. Le seuil est √©lev√© pour prendre en compte d'√©ventuels embouteillage

    cee_application_import:
      type: object
      description: Pr√©c√©dente demande de CEE
      additionalProperties: false
      required:
        - phone_trunc
        - last_name_trunc
        - datetime
        - journey_type
      properties:
        journey_type:
          '$ref': '#/components/schemas/journey_type'
        phone_trunc:
          '$ref': '#/components/schemas/phone_trunc'
        last_name_trunc:
          '$ref': '#/components/schemas/last_name_trunc'
        datetime:
          type: string
          format: datetime
          description: Date d'engagement de l'op√©ration concern√©e.
    cee_application_identity_import:
      type: object
      description: |
        Pr√©c√©dente demande de CEE.
        S'il s'agit d'une op√©ration sp√©cifique, le payload est le m√™me que sur l'import, en ajoutant le champs "cee_application_type": "specific".
        S'il s'agit d'une op√©ration standaris√©e, il convient d'envoyer l'uuid de la demande tel que : { cee_application_type: 'standardized', cee_application_uuid: 'uuid de la demande', identity_key: 'cl√©e' }.
      additionalProperties: false
      oneOf:
        - required:
          - Demandes CEE_application_type
          - Demandes CEE_application_uuid
          - identity_key
        - required:
          - Demandes CEE_application_type
          - identity_key
          - phone_trunc
          - last_name_trunc
          - journey_type
          - datetime
      properties:
        cee_application_type:
          '$ref': '#/components/schemas/cee_application_type'
        cee_application_uuid:
          '$ref': '#/components/schemas/cee_application_uuid'
        identity_key:
          '$ref': '#/components/schemas/identity_key'
        journey_type:
          '$ref': '#/components/schemas/journey_type'
        phone_trunc:
          '$ref': '#/components/schemas/phone_trunc'
        last_name_trunc:
          '$ref': '#/components/schemas/last_name_trunc'
        datetime:
          type: string
          format: datetime
          description: Date d'engagement de l'op√©ration concern√©e.
    cee_application_identity_import_response:
      type: object
      description: Retour de la requ√™te d'import des demandes CEE en batch
      additionalProperties: false
      required:
        - imported
        - failed
        - failed_details
      properties:
        imported:
          type: number
          minimum: 0
          maximum: 1000
          description: Nombre de demandes import√©es avec succ√®s
        failed:
          type: number
          minimum: 0
          maximum: 1000
          description: Nombre de demandes non import√©es
        failed_details:
          type: array
          minItems: 0
          maxItems: 1000
          items:
            allOf:
              - '$ref': '#/components/schemas/cee_application_identity_import'
              - type: object
                required: 
                  - error
                properties:
                  error:
                    type: string
    cee_application_import_response:
      type: object
      description: Retour de la requ√™te d'import des demandes CEE en batch
      additionalProperties: false
      required:
        - imported
        - failed
        - failed_details
      properties:
        imported:
          type: number
          minimum: 0
          maximum: 1000
          description: Nombre de demandes import√©es avec succ√®s
        failed:
          type: number
          minimum: 0
          maximum: 1000
          description: Nombre de demandes non import√©es
        failed_details:
          type: array
          minItems: 0
          maxItems: 1000
          items:
            allOf:
              - '$ref': '#/components/schemas/cee_application_import'
              - type: object
                required: 
                  - error
                properties:
                  error:
                    type: string
    cee_application_type:
      type: string
      description: Type de demande cee
      enum:
        - specific
        - standardized
    cee_application_uuid:
      type: string
      format: uuid
      description: UUID V4 de la demande
    cee_application:
      type: object
      description: Demande de CEE
      additionalProperties: false
      required:
        - datetime
        - uuid
        - token
      properties:
        datetime:
          type: number
          description: Date de l'op√©ration, en l'occurence date de fin du trajet pour la courte distance et date de paiement pour la longue.
        uuid:
          '$ref': '#/components/schemas/cee_application_uuid'
        journey_id:
          type: number
          description: Num√©ro de trajet interne au rpc correspondant √† l'operator_journey_id envoy√©
        status:
          type: string
          description: Statut du trajet correspondant √† l'operator_journey_id envoy√©.
        token:
          type: string
          description: signature(sha512([SIRET_OPERATEUR]/[journey_type]/[driving_license]//[DATETIME UTC]))
          example: signature(sha512(13002526500013/short/051227308989/2022-11-22T08:54:19Z))


paths:
  /journeys:
    post:
      tags:
      - Trajets courte distance
      summary: Envoyer un trajet
      description: |
        #### Pr√©cisions d'usage :

        - **Attention**, l'API v3.1 n√©cessite d'envoyer des preuves au plus tard 24h apr√®s le d√©but du trajet.
        - Un _rate limiting_ de 20000 requ√™tes par minute est appliqu√© sur l'envoi des trajets. Les diff√©rents points d'API ont des _rate limiters_ ind√©pendants.

        ---

        Un trajet est un couple passager.√®re / conducteur.rice ayant des points et de horaires de d√©part et d'arriv√©e. Si une conductrice covoiture avec plusieurs passag√®res, plusieurs trajets sont d√©clar√©s.

        ### Unit√©s de mesure

        Les unit√©s utilis√©es pour les valeurs sont :

        - montants financiers en **centimes d'Euros**
        - distances en **m√®tres**

        ### Donn√©es financi√®res

        Le principe est de coller au plus pr√®s avec la r√©alit√© comptable \(transaction usager\) et d'avoir suffisamment d'informations pour recalculer le co√ªt initial du trajet.
        Ainsi, les propri√©t√©s `passenger.contribution` et `driver.revenue` combin√©es au tableau `incentives` doivent permettre ce calcul.
        Ceci afin de s'assurer du respect de la d√©finition du covoiturage et de la bonne application des politiques incitatives g√©r√©es par le registre.
        > Les donn√©es envoy√©es en `passenger.contribution` et `driver.revenue` sont utilis√©es dans les attestations de covoiturage √† destination des employeurs (Forfait Mobilit√©s Durables).

        ### Validation
        
        Le sch√©ma de donn√©es est pr√©sent√© au format [JSON Schema Draft-07](https://json-schema.org/understanding-json-schema/index.html).

        ### V√©rification
        Les v√©rifications sont faites de mani√®re asynchrone.
        Le statut ne peut plus changer 48h apr√®s la date de fin du trajet.
        En cas d'indisponibilit√© du ou des services, le trajet est consid√©r√© comme `ok` apr√®s 48h

        ## D√©tection de fraude

        Dans le cadre de la fraude inter op√©rateurs, les op√©rateurs sont tenus de v√©rifier le statut du trajet au plus t√¥t 24h apr√®s la r√©alisation de celui-ci.
        Ces trajets seront retourn√©s avec un champs `status` √† `fraud_error` et un label dans `fraud_error_labels` √† `interoperator_fraud`.
        L'algorithme de d√©tection de fraude inter op√©rateurs est appliqu√© sur tous les trajets envoy√©s.

        ## D√©tection d'anomalie

        Le trajet est incoh√©rent ou physiquement impossible.
        Le trajet envoy√© rentre en conflit avec un autre sur plan temporel ou spacial
        Voir la section du schema "anomaly_label" pour plus de d√©tails
      operationId: acquisition:create
      requestBody:
        required: true
        content:
          'application/json':
            schema:
              type: object
              required:
                - operator_journey_id
                - operator_trip_id
                - incentives
                - operator_class
                - start
                - end
                - distance
                - driver
                - passenger
              additionalProperties: false
              properties:
                operator_journey_id:
                  '$ref': '#/components/schemas/operator_journey_id'
                operator_trip_id:
                  '$ref': '#/components/schemas/operator_trip_id'
                operator_class:
                  '$ref': '#/components/schemas/operator_class'
                incentives:
                  '$ref': '#/components/schemas/incentives'
                licence_plate:
                  '$ref': '#/components/schemas/licence_plate'
                start:
                  '$ref': '#/components/schemas/time_geopoint'
                end:
                  '$ref': '#/components/schemas/time_geopoint'
                distance:
                  '$ref': '#/components/schemas/distance'
                driver:
                  '$ref': '#/components/schemas/driver'
                passenger:
                  '$ref': '#/components/schemas/passenger'
      responses:
        '201':
          description: OK. Le trajet a bien √©t√© enregistr√©.
          content:
            'application/json':
               schema:
                 type: object
                 required:
                   - operator_journey_id
                   - created_at
                 properties:
                   operator_journey_id:
                     '$ref': '#/components/schemas/operator_journey_id'
                   created_at:
                     type: string
                     format: date-time
                     description: La date de cr√©ation dans le registre
        '400':
          description: Mauvaise requ√™te
          content:
            'application/json':
              example:
                id: 1
                error:
                  data: "data/driver/identity/phone_trunc must match format \"phonetrunc\", data/driver/identity/phone_trunc must pass \"macro\" keyword validation"
                  code: -32602
                  message: Invalid params
                jsonrpc: '2.0'
        '401':
          description: Non authentifi√©. Le token applicatif est manquant ou invalide
          content:
            'application/json':
              example:
                code: 401
                error: Unauthorized
        '403':
          description: |
            Acc√®s refus√©
            Les permissions de votre token applicatif ne vous permettent pas de cr√©er une attestation.
            Vous pouvez g√©n√©rer un nouveau token et r√©essayer. Si le probl√®me persiste, [contactez notre √©quipe](mailto:technique@covoiturage.beta.gouv.fr).
          content:
            'application/json':
              example:
                code: 403
                error: Forbidden
        '409':
          description: |
            Le trajet est d√©j√† enregistr√©.
    get:
      tags:
      - Trajets courte distance
      summary: Liste des trajets
      description: |
        La liste est toujours ordonn√©e de mani√®re antechronologique.
        Les trajets apparaissent au plus tard 24h apr√®s leur envoi.
        Dans le cadre de la fraude inter-op√©rateurs, les op√©rateurs sont tenus de v√©rifier le statut du trajet au plus t√¥t 48h apr√®s la r√©alisation de celui-ci.
        Ces trajets peuvent √™tre list√©s en passant un param√®tre `status` √† `fraud_error`.
      parameters:
        - name: status
          in: query
          description: Statut du trajet
          required: true
          example: "ok"
          schema:
            '$ref': '#/components/schemas/status'
        - name: limit
          in: query
          description: Limite, par d√©faut 50.
          schema:
            '$ref': '#/components/schemas/limit'
        - name: start
          in: query
          required: false
          description: Date de d√©but de recherche, par d√©faut dans la semaine qui pr√©c√®de. Elle ne peut pas √™tre inf√©rieure √† 90 jours √† la date du jour.
          schema:
            '$ref': '#/components/schemas/datetime'
        - name: end
          in: query
          required: false
          description: Date de fin de recherche, par d√©faut le jour m√™me.
          schema:
            '$ref': '#/components/schemas/datetime'
        - name: offset
          in: query
          description: Offset, par d√©faut 0.
          required: false
          schema:
            '$ref': '#/components/schemas/offset'
      responses:
        '200':
          description: Ok
          content:
            'application/json':
              schema:
                type: array
                items:
                  type: object
                  required:
                    - operator_journey_id
                  properties:
                    operator_journey_id:
                      '$ref': '#/components/schemas/operator_journey_id'
  /journeys/{operator_journey_id}:
    parameters:
      - name: operator_journey_id
        in: path
        description: operator_journey_id of the journey created
        required: true
        schema:
          '$ref': '#/components/schemas/operator_journey_id'
    get:
      tags:
      - Trajets courte distance

      operationId: acquisition:status
      summary: V√©rifier le statut d'un trajet envoy√©
      description: |
        Lors de l'envoi d'un trajet, un code 201 et un payload avec le `operator_journey_id` et la date de cr√©ation vous sont renvoy√©s. Le trajet est alors enregistr√© dans notre base. Le processus de validation par lequel vont passer les donn√©es est complexe, asynchrone et d√©pend de diff√©rents services ayant de temps de r√©ponse variables.
        Les trajets ne seront visibles dans l'interface utilisateurs que **24 heures** apr√®s leur envoi.

        Il est possible de v√©rifier le statut d'un trajet envoy√© directement pour s'assurer qu'il n'y pas pas eu d'erreur de format ou de traitement.

        Dans le cadre de la fraude inter op√©rateurs, les op√©rateurs sont tenus de v√©rifier le statut du trajet au plus t√¥t 24h apr√®s la r√©alisation de celui-ci.
        Un trajet detect√© sera retourn√© avec un champ `status` √† `fraud_error`.
        Le statut ne peut plus changer 48h apr√®s la date de fin du trajet. En cas d'indisponibilit√© du service, le trajet est consid√©r√© comme ok apr√®s les 48h
        L'algorithme de d√©tection de fraude inter op√©rateurs est appliqu√© sur tous les trajets envoy√©s.
      responses:
        '200':
          description: |
            OK
            Le trajet a √©t√© trouv√© et son statut est retourn√©.
            Attention, le trajet peut √™tre en erreur malgr√© le code 200, v√©rifiez le statut retourn√©.
          content:
            'application/json':
              schema:
                type: object
                required:
                  - status
                  - operator_journey_id
                  - created_at
                properties:
                  status:
                    '$ref': '#/components/schemas/status'
                  operator_journey_id:
                    '$ref': '#/components/schemas/operator_journey_id'
                  created_at:
                    type: string
                    format: date-time
                    description: la date d'enregistrement du trajet ou √† d√©faut d'enregistrement, la date de l'erreur d'enregistrement
                  fraud_error_labels:
                    type: array
                    description: Liste des raisons ayant abouti au rejet du trajet. vide si pas de fraude d√©tect√©e
                    items:
                      '$ref': "#/components/schemas/fraudcheck_label"
                  anomaly_error_details:
                    type: array
                    description: Liste des raisons ayant abouti au rejet du trajet. vide si pas d'anomalie d√©tect√©e
                    items:
                      properties:
                        label:
                          '$ref': "#/components/schemas/anomaly_label"
                        metas:
                          type: object
                          properties:
                            conflicting_journey_id:
                              type: string
                              description: l'`operator_journey_id` en conflict avec le trajet rejet√©. Le trajet correspondant √† ce journey_id ne sera pas retenu en statut `anomaly_error`.
                            temporal_overlap_duration_ratio:
                              type: number
                              description: ratio de temps de chevauchement entre les 2 trajets allant de 0 √† 1. 1 d√©signe un chevauchement de temps total
                  terms_violation_details:
                    type: array
                    description: | 
                      Liste des raisons ayant abouti au rejet du trajet.
                    items:
                      '$ref': "#/components/schemas/terms_violation_label"
        '401':
          description: Non authentifi√©. Le token applicatif est manquant ou invalide
          content:
            'application/json':
              example:
                code: 401
                error: Unauthorized
        '403':
          description: |
            Acc√®s refus√©
            Les permissions de votre token applicatif ne vous permettent pas de cr√©er une attestation.
            Vous pouvez g√©n√©rer un nouveau token et r√©essayer. Si le probl√®me persiste, [contactez notre √©quipe](mailto:technique@covoiturage.beta.gouv.fr).
          content:
            'application/json':
              example:
                code: 403
                error: Forbidden
        '404':
          description: Le trajet n'a pas √©t√© trouv√©
          content:
            'application/json':
              example:
                code: 404
                error: Not found
    patch:
      tags:
      - Trajets courte distance

      summary: Mettre √† jour un trajet
      description: |
        Permet de mettre √† jour un trajet qui est en erreur suite √† un probl√®me de validation sur le payload. Par exemple suite √† un probl√®me de validation sur les coordonn√©es g√©ographiques envoy√©es
      operationId: acquisition:update
      requestBody:
        required: true
        content:
          'application/json':
            schema:
              type: object
              required:
                - incentives
                - operator_class
                - start
                - end
                - distance

              additionalProperties: false
              properties:
                operator_trip_id:
                  '$ref': '#/components/schemas/operator_trip_id'
                operator_class:
                  '$ref': '#/components/schemas/operator_class'
                incentives:
                  '$ref': '#/components/schemas/incentives'
                start:
                  '$ref': '#/components/schemas/time_geopoint'
                end:
                  '$ref': '#/components/schemas/time_geopoint'
                distance:
                  '$ref': '#/components/schemas/distance'
      responses:
        '200':
          description: ok
  /journeys/{operator_journey_id}/cancel:
    parameters:
      - name: operator_journey_id
        in: path
        description: operator_journey_id of the journey created
        required: true
        schema:
          '$ref': '#/components/schemas/operator_journey_id'
    post:
      tags:
      - Trajets courte distance
      summary: Invalider un trajet envoy√©
      description: |
        Annule un trajet d√©j√† envoy√© dans le registre.
        S'il d√©tecte un comportement inhabituel ou une fraude av√©r√©e, un op√©rateur doit communiquer aupr√®s du service l'invalidation du trajet concern√© d√®s lors qu'il est d√©j√† inscrit dans le registre.
        Cette invalidation doit avoir lieu d√®s que l'op√©rateur a connaissance de cette irr√©gularit√© √† tout moment.

        Le `code` est un champ libre de 32 caract√®res maximum. Obligatoire.
        Le `message` est un champ libre pour expliquer la raison de l'invalidation. Optionnel.

      operationId: acquisition:cancel
      requestBody:
        required: true
        content:
          'application/json':
            schema:
              type: object
              required:
                - code
              additionalProperties: false
              properties:
                code:
                  type: string
                  pattern: ^[0-9A-Za-z_-]{0,32}$
                message:
                  type: string
                  maxLength: 512
      responses:
        '200':
          description: |
            Ok
            La demande d'invalidation a √©t√© prise en compte
        '401':
          description: Non authentifi√©. Le token applicatif est manquant ou invalide
          content:
            'application/json':
              example:
                code: 401
                error: Unauthorized
        '403':
          description: |
            Acc√®s refus√©
            Les permissions de votre token applicatif ne vous permettent pas de cr√©er une attestation.
            Vous pouvez g√©n√©rer un nouveau token et r√©essayer. Si le probl√®me persiste, [contactez notre √©quipe](mailto:technique@covoiturage.beta.gouv.fr).
          content:
            'application/json':
              example:
                code: 403
                error: Forbidden
        '404':
          description: Le trajet n'a pas √©t√© trouv√©
          content:
            'application/json':
              example:
                code: 404
                error: Not found
  /policies/simulate:
    post:
      tags:
        - Campagnes
      summary: Simuler une incitation sur un trajet

      requestBody:
        required: true
        content:
          'application/json':
            schema:
              type: object
              required:
                - operator_class
                - start
                - end
                - distance
                - driver
                - passenger
              additionalProperties: false
              properties:
                operator_class:
                  '$ref': '#/components/schemas/operator_class'
                start:
                  '$ref': '#/components/schemas/time_geopoint'
                end:
                  '$ref': '#/components/schemas/time_geopoint'
                distance:
                  '$ref': '#/components/schemas/distance'
                driver:
                  '$ref': '#/components/schemas/driver'
                passenger:
                  '$ref': '#/components/schemas/passenger'
      responses:
        '200':
          description: |
            L'API retourne un objet avec les incitations sur le trajet soumis. Attention, ce calcul n'est pas d√©finitif en raison des seuils qui peuvent s'appliquer sur une campagne. Par exemple, une campagne limitant le nombre de trajets par jour √† X. C'est donc un r√©sultat provisoire - sans valeur contractuelle - qui est retourn√©.
          content:
            'application/json':
              schema:
                type: object
                required:
                  - incentives
                properties:
                  incentives:
                    '$ref': '#/components/schemas/incentives'
  /geo/route:
    get:
      tags:
      - G√©ographie

      summary: Calcul th√©orique de la distance et de la dur√©e
      parameters:
        - name: start
          in: query
          required: true
          schema:
            '$ref': '#/components/schemas/geopoint'
        - name: end
          in: query
          required: true
          schema:
            '$ref': '#/components/schemas/geopoint'
      responses:
        '200':
          description: Ok
          content:
            'application/json':
              schema:
                type: object
                required:
                  - distance
                  - duration
                properties:
                  distance:
                    '$ref': '#/components/schemas/distance'
                  duration:
                    '$ref': '#/components/schemas/duration'
  /geo/point/by_address:
    get:
      tags:
      - G√©ographie

      summary: Geocoding √† partir d'une adresse lit√©rale
      parameters:
        - name: literal
          in: query
          description: Adresse litt√©rale
          example: 5 rue du Paradis, 75010 Paris
          required: true
          schema:
            type: string
        - name: country
          in: query
          description: Nom complet du pays
          example: France
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Ok
          content:
            'application/json':
              schema:
                '$ref': '#/components/schemas/geopoint'
  /geo/point/by_insee:
    get:
      tags:
      - G√©ographie

      summary: Geocoding √† partir d'un code insee
      parameters:
        - name: code
          in: query
          description: |
            Code INSEE commune ou arrondissement de la position
            Pour le m√©tropoles qui comportent un code INSEE global et des codes par arrondissement, utiliser le code arrondissement.
          example: "91177"
          schema:
            type: string
      responses:
        '200':
          description: Ok
          content:
            'application/json':
              schema:
                '$ref': '#/components/schemas/geopoint'

  /exports:
    post:
      tags: 
        - Export de trajets

      summary: Exporter des trajets
      description: |
        ## Exporter des trajets en CSV

        Les exports sont conserv√©s 7 jours.
        
        La cr√©ation d'un export peut prendre plusieurs minutes.
      operationId: export:createVersionThree
      requestBody:
        required: true
        content:
          'application/json':
            schema:
              type: object
              required:
                - tz
                - start_at
                - end_at
                - operator_id
              additionalProperties: false
              properties:
                tz: 
                  type: string
                  description: Fuseau horaire
                  example: Europe/Paris
                start_at:
                  type: string
                  format: date-time
                  description: |
                    Date de d√©but au format ISO. S√©lectionne les trajets >= date
                  example: 2024-01-01T00:00:00+0100
                end_at:
                  type: string
                  format: date-time
                  description: |
                    Date de fin au format ISO n√©cessairement sup√©rieur √†
                    start_at. S√©lectionne les trajets < date
                  example: 2024-02-01T00:00:00+0100
                operator_id:
                  type: array
                  minItems: 0
                  maxItems: 128
                  description: Identifiant du ou des op√©rateurs √† exporter
                  items:
                    type: number
                  example: [1, 2, 3]
                recipients:
                  type: array
                  minItems: 0
                  maxItems: 24
                  description: |
                    Liste des adresses email des destinataires de l'export. Ces
                    personnes recevront une notification avec un lien de
                    t√©l√©chargement.
                  items:
                    type: string
                    format: email
                geo_selector:
                  '$ref': '#/components/schemas/geo_selector'
      responses:
        '201':
          description: |
            La demande d'export a √©t√© cr√©√©e. Un email sera envoy√© aux
            destinataires avec un lien de t√©l√©chargement une fois l'export termin√©e.

            En cas d'erreur, la personne qui a command√© l'export sera notifi√©e,
            ainsi que l'√©quipe technique du RPC.
          content:
            'application/json':
              schema:
                type: object
                required:
                  - uuid
                properties:
                  uuid:
                    type: string
                    format: uuid
                    example: 8a9d2da9-39e3-4db7-be8e-12b4d2179fda
                  target:
                    type: string
                    enum: [operator, territory, opendata]
                  status:
                    type: string
                    enum: [pending, running, uploading, uploaded, notify, success, failure]
                  start_at:
                    type: string
                    format: date-time
                    example: 2024-01-01T00:00:00+0100
                  end_at:
                    type: string
                    format: date-time
                    example: 2024-02-01T00:00:00+0100
      
  /certificates:
    post:
      tags:
      - Attestations op√©rateurs (d√©pr√©ci√©)

      summary: Cr√©er une attestation
      description: |
        ## Configuration de la requ√™te

        1. La requ√™te est authentifi√©e avec un [token applicatif](/operateurs/preuves/acces) √† ajouter √† l'ent√™te de la requ√™te : `Authorization: Bearer <token>`
        2. Le fuseau horaire est requis
        2. L'identit√© est requise
        3. Le filtrage g√©ographique est optionnel
        4. Les dates de d√©but et de fin sont optionnelles
        5. La date de fin la plus r√©cente possible est J-6
        6. La date de d√©but la plus ancienne est le 1er janvier de l'ann√©e pr√©c√©dente

        ## Cr√©ation simple

        Les donn√©es requises pour la cr√©ation ne concernent que l'identit√© de la personne et le fuseau horaire.

        Par d√©faut, l'attestation sera g√©n√©r√©e pour l'ann√©e pr√©c√©dente sans restrictions g√©ographiques.

        Chaque appel, m√™me si les param√®tres sont les m√™mes, entraine la cr√©ation d'une attestation unique.

        Les attestations ne peuvent √™tre supprim√©es. [Contactez notre √©quipe](mailto:technique@covoiturage.beta.gouv.fr) au besoin.

        ### Astuce
        Vous pouvez r√©cup√©rer le fuseau horaire de l'utilisateur en Javascript.
        ```js
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        ```
      operationId: certificate:create
      requestBody:
        required: true
        content:
          'application/json':
            schema:
              type: object
              required:
                - identity
                - tz
              additionalProperties: false
              properties:
                identity:
                  '$ref': '#/components/schemas/identitycert'
                tz:
                  type: string
                  description: fuseau horaire
                  example: Europe/Paris
                start_at:
                  type: string
                  format: date-time
                  description: Date de d√©but au format ISO. S√©lectionne les trajet >= date
                  example: 2021-01-01T00:00:00+0100
                end_at:
                  type: string
                  format: date-time
                  description: Date de fin au format ISO n√©cessairement sup√©rieur √† start_at. S√©lectionne les trajets < date
                  example: 2021-07-01T00:00:00+0200
                positions:
                  type: array
                  minItems: 2
                  description: |
                    Pour s√©lectionner des trajets en fonction de leur point de d√©part et d'arriv√©e, il est possible de les pr√©ciser avec la cl√© `positions`.
                    Tous les trajets ayant un d√©part **et** une arriv√©e dans un rayon de `1km` autour des points donn√©s seront inclus √† l'attestation.
                  items:
                    '$ref': "#/components/schemas/geopoint"
      responses:
        '201':
          description: OK
          content:
            'application/json':
              schema:
                type: object
                description: |
                  Les donn√©es calcul√©es de l'attestation sont retourn√©es dans la r√©ponse pour permettre leur affichage par votre application.
                  Vous pouvez reconstruire l'URL de validation publique avec l'UUID.
                properties:
                  uuid:
                    type: string
                    format: uuid
                    example: 8a9d2da9-39e3-4db7-be8e-12b4d2179fda
                  created_at:
                    type: string
                    format: date-time
                    example: 2020-01-01T00:00:00+0100
                  meta:
                    type: object
                    properties:
                      tz:
                        type: string
                        example: Europe/Paris
                      positions:
                        type: array
                        items:
                          '$ref': "#/components/schemas/geopoint"
                      driver:
                        '$ref': '#/components/schemas/certificate_data'
                      passenger:
                        '$ref': '#/components/schemas/certificate_data'
        '401':
          description: Non authentifi√©. Le token applicatif est manquant ou invalide
          content:
            'application/json':
              example:
                code: 401
                error: Unauthorized
        '403':
          description: |
            Acc√®s refus√©
            Les permissions de votre token applicatif ne vous permettent pas de cr√©er une attestation.
            Vous pouvez g√©n√©rer un nouveau token et r√©essayer. Si le probl√®me persiste, [contactez notre √©quipe](mailto:technique@covoiturage.beta.gouv.fr).
          content:
            'application/json':
              example:
                code: 403
                error: Forbidden
        '404':
          description: L'identit√© n'a pu √™tre trouv√©e. V√©rifiez les identifiants envoy√©s.
          content:
            'application/json':
              example:
                code: 404
                error: Not found
  /certificates/{uuid}/attachment:
    parameters:
      - name: uuid
        in: path
        description: Identifiant de l'attestation pr√©c√©demment cr√©√©.
        required: true
        schema:
          type: string
          format: uuid
    post:
      tags:
      - Attestations op√©rateurs (d√©pr√©ci√©)
      summary: T√©l√©charger une attestation
      description: |
        ## Upload du logo op√©rateur

        Vous pouvez personnaliser le logo op√©rateur pr√©sent sur l'attestation.

        Contrairement aux meta-donn√©es envoy√©es lors de la cr√©ation de l'attestation, le logo est configur√© au pr√©alable via le page de profil de votre op√©rateur.

        - [Ajouter mon logo en production](https://app.covoiturage.beta.gouv.fr/admin/operator)
        - [Ajouter mon logo pour les tests](https://app.demo.covoiturage.beta.gouv.fr/admin/operator)

        > _Le poids de l'image est de 2Mo maximum et sa taille de 1024x1024 pixels._

        ## T√©l√©chargement

        Une fois l'attestation cr√©√©e en base \(201 created\), on peut t√©l√©charger un PDF en y ajoutant des donn√©es permettant une identification simplifi√©e de la personne.

        Ces meta-donn√©es optionnelles ne sont pas stock√©es sur nos serveurs, elles sont ajout√©es au document g√©n√©r√© √† la vol√©e.

        Le PDF g√©n√©r√© n'est pas stock√© sur nos serveurs. L'appel d'API vous renvoie un fichier binaire que vous sauvegardez de votre c√¥t√©. Vous pouvez g√©n√©rer le PDF d'une attestation plusieurs fois de suite.

      operationId: certificate:download
      requestBody:
        required: true
        content:
          'application/json':
            schema:
              type: object
              additionalProperties: false
              properties:
                meta:
                  type: object
                  description: |
                    personnalisation optionnelle de l'en-t√™te
                    omettre 'meta' si pas de personnalisation
                    toutes les propri√©t√©s sont facultatives
                  properties:
                    operator:
                      type: string
                      maxLength: 305
                      description: |
                        zone de texte. Maximum de 305 caract√®res
                        Maximum de 6 lignes s√©par√©es par \n
                    identity:
                      type: object
                      properties:
                        name:
                          type: string
                          maxLength: 26
                          description: Nom de la personne
                        content:
                          type: string
                          maxLength: 305
                          description: |
                            zone de texte. Maximum de 305 caract√®res
                            Maximum de 6 lignes s√©par√©es par \n
                    note:
                      type: string
                      description: |
                        zone de texte. Maximum de 440 caract√®res
                        Retour √† la ligne automatique

      responses:
        '200':
          description: |
            OK, le fichier binaire est envoy√©.
            ![Attestations](/attestations.png)
        '401':
          description: Non authentifi√©. Le token applicatif est manquant ou invalide
          content:
            'application/json':
              example:
                code: 401
                error: Unauthorized
        '403':
          description: |
            Acc√®s refus√©
            Les permissions de votre token applicatif ne vous permettent pas de cr√©er une attestation.
            Vous pouvez g√©n√©rer un nouveau token et r√©essayer. Si le probl√®me persiste, [contactez notre √©quipe](mailto:technique@covoiturage.beta.gouv.fr).
          content:
            'application/json':
              example:
                code: 403
                error: Forbidden
        '404':
          description: L'attestation n'a pu √™tre trouv√©e
          content:
            'application/json':
              example:
                code: 404
                error: Not found
  /certificates/{uuid}:
    parameters:
      - name: uuid
        in: path
        description: Identifiant de l'attestation pr√©c√©demment cr√©√©.
        required: true
        schema:
          type: string
          format: uuid
        example: 9415300a-7a51-4296-96d1-68636e46485d
    get:
      tags:
      - Attestations op√©rateurs (d√©pr√©ci√©)
      summary: V√©rifier une attestation

      operationId: certificate:verify
      parameters: []
      responses:
        '200':
          description: OK
          content:
            'application/json':
              schema:
                type: object
                properties:
                  type:
                    type: string
                    enum:
                      - ok
                      - expired
                  uuid:
                    type: string
                    format: uuid
                    example: 8a9d2da9-39e3-4db7-be8e-12b4d2179fda
                  tz:
                    type: string
                    example: Europe/Paris
                  start_at:
                    type: string
                    format: date-time
                    example: 2020-01-01T00:00:00+0100
                  end_at:
                    type: string
                    format: date-time
                    example: 2020-01-01T00:00:00+0100
                  created_at:
                    type: string
                    format: date-time
                    example: 2020-01-01T00:00:00+0100
                  identity:
                    type: object
                    properties:
                      uuid:
                        type: string
                        format: uuid
                  operator:
                    type: object
                    properties:
                      _id:
                        type: integer
                      uuid:
                        type: string
                        format: uuid
                      name:
                        type: string
                  positions:
                    type: array
                    items:
                      '$ref': "#/components/schemas/geopoint"
                  driver:
                    '$ref': '#/components/schemas/certificate_data'
                  passenger:
                    '$ref': '#/components/schemas/certificate_data'
        '401':
          description: Non authentifi√©. Le token applicatif est manquant ou invalide
          content:
            'application/json':
              example:
                code: 401
                error: Unauthorized
        '403':
          description: |
            Acc√®s refus√©
            Les permissions de votre token applicatif ne vous permettent pas de cr√©er une attestation.
            Vous pouvez g√©n√©rer un nouveau token et r√©essayer. Si le probl√®me persiste, [contactez notre √©quipe](mailto:technique@covoiturage.beta.gouv.fr).
          content:
            'application/json':
              example:
                code: 403
                error: Forbidden
        '404':
          description: L'attestation n'a pu √™tre trouv√©e
          content:
            'application/json':
              example:
                code: 404
                error: Not found

  /policies/cee:
    post:
      tags:
      - Demandes CEE
      summary: Enregistrer une demande CEE
      description: |
        V√©rification compl√®te de l'√©ligibilit√© de l'usager (historique et
        d√©doublonnage) et enregistrement de la demande CEE dans l'API CEE :
        
        - Si la conformit√© de la demande est valide, alors une r√©ponse 201 est retourn√©e validant l'enregistrement de la demande.
        - Si une demande a d√©j√† √©t√© enregistr√©e pour l'usager en question, alors une r√©ponse 409 est retourn√©e avec la date √† laquelle l'enregistrement a √©t√© fait.
        - Si le trajet envoy√© n'est pas trouv√©, alors une r√©ponse 404 est retourn√©e.
       
        Ce point d'API est consultable √† `J+7` pour la courte et la longue
        distance, `J` √©tant la date de r√©alisation du trajet. Il est pr√©vu que
        ce d√©lai soit r√©duit √† 48h apr√®s la r√©alisation du trajet suite au
        d√©ploiement de l'API V3.
      operationId: policy:cee:register
      requestBody:
        required: true
        content:
          'application/json':
            schema:
              oneOf:
                - '$ref': '#/components/schemas/short_distance_application'
                - '$ref': '#/components/schemas/long_distance_application'
      responses:
        '201':
          description: Ok, la demande est enregistr√©e
          content:
            'application/json':
              schema:
                '$ref': '#/components/schemas/cee_application'
        '404':
          description: |
            La demande n'a pas pu aboutir car un trajet √©ligible n'a pas √©t√© trouv√© soit parce que
            l'identifiant envoy√© ne correspond pas √† un trajet inscrit dans le registre,
            soit parce que celui-ci ne correspond pas au crit√®res d'√©ligibilit√©.
            Pour rappel, un trajet √©ligible est un trajet:
              - apr√®s le 1er janvier 2023
              - de moins de 80 km
              - dont le d√©part ou l'arriv√©e est en France
              - de classe C
        '400':
          description: |
            - "expired" : correspond a un trajet envoy√© "hors d√©lais". Il faut qu'il soit enregistr√© dans le RPC dans les 5 jours qui suivent sa r√©alisation
            - "Date should be before 7 days from now" : correspondant √† un appel √† l'API CEE qui aurait √©t√© fait √† moins de J+7 de la date de fin du trajet 
              sur la courte distance et √† moins de J+7 de la date de paiement au conducteur par l'op√©rateur sur le longue distance.
        '409':
          description: |
            Une demande similaire a d√©j√† enregistr√©e.
            Si elle a d√©j√† √©t√© enregistr√©e par le m√™me op√©rateur, alors la r√©ponse contient l'UUID de la demande, le `journey_id` et le `status` si la demande initiale concerne la courte distance.
            Dans le cas contraire, seul le champs datetime correspondant √† la date de l'op√©ration est renvoy√©.
          content:
            'application/json':
              schema:
                type: object
                properties:
                  datetime:
                    type: string
                    format: datetime
                    description: Date de l'op√©ration, en l'occurence date de fin du trajet pour la courte distance et date de paiement pour la longue.
                  uuid:
                    type: string
                    format: uuid
                    description: UUID V4 de la demande si la demande a d√©j√† √©t√© effectu√©e par l'op√©rateur.
  /policies/cee/simulate:
    post:
      tags:
      - Demandes CEE
      summary: Simuler une demande CEE
      description: |
        Possibilit√© de simuler une demande avant la r√©alisation du trajet par un
        usager afin de v√©rifier partiellement la pr√©-√©ligibilit√© de ce dernier
        (v√©rification de l'historique mais pas du d√©doublonn√©ge).
        
        Seront n√©cessaire : num√©ros de permis de conduire, trois premi√®res
        lettres du nom de famille et 8 premiers chiffres du num√©ro de t√©l√©phone.
      operationId: policy:cee:simulate
      requestBody:
        required: true
        content:
          'application/json':
            schema:
              type: object
              additionalProperties: false
              required:
                - last_name_trunc
                - phone_trunc
                - journey_type
              properties:
                driving_license:
                  '$ref': '#/components/schemas/driving_license'
                last_name_trunc:
                  '$ref': '#/components/schemas/last_name_trunc'
                phone_trunc:
                  '$ref': '#/components/schemas/phone_trunc'
                journey_type:
                  '$ref': '#/components/schemas/journey_type'
                identity_key:
                  '$ref': '#/components/schemas/identity_key'
      responses:
        '200':
          description: Ok, la demande est possible
        '409':
          description: Une demande similaire a d√©j√† √©t√© enregistr√©e
          content:
            'application/json':
              schema:
                type: object
                properties:
                  datetime:
                    type: string
                    format: datetime
                    description: Date √† laquelle la demande a √©t√© effectu√©e
                  uuid:
                    type: string
                    format: uuid
                    description: UUID V4 de la demande si la demande a d√©j√† √©t√© effectu√©e par l'op√©rateur.
  /policies/cee/import:
    post:
      tags:
      - Demandes CEE
      summary: Importez des demandes CEE existantes par lot
      description: |
        Envoi par chaque op√©rateur concern√© de l'historique des b√©n√©ficiaires
        d'op√©rations sp√©cifiques sur les 3 ann√©es pr√©c√©dents 2023. Pour chaque
        b√©n√©ficiaires les informations suivantes seront requises : phone_trunc,
        last_name_trunc, datetime et journey_type √Ä noter que ce point d'API ne
        sera peut-√™tre pas mis en place et remplac√© par un CSV standardis√©.
        
        Afin que l'API soit fonctionnelle, les op√©rateurs doivent faire remonter
        l'historique au registre au plus t√¥t.
      operationId: policy:cee:import
      requestBody:
        required: true
        content:
          'application/json':
            schema:
              type: array
              maxItems: 1000
              items:
                '$ref': '#/components/schemas/cee_application_import'
      responses:
        '201':
          description: Ok
          content:
            'application/json':
              schema:
                '$ref': '#/components/schemas/cee_application_import_response'
  /policies/cee/import/identity:
    post:
      tags:
      - Demandes CEE
      summary: Importez les cl√©s d'identit√© des demandes CEE existantes par lot
      description: |
        L'API peut √™tre utilis√©e jusqu'√† 20.000x par minute.

      operationId: policy:cee:import:identity
      requestBody:
        required: true
        content:
          'application/json':
            schema:
              type: array
              maxItems: 1000
              items:
                '$ref': '#/components/schemas/cee_application_identity_import'
      responses:
        '200':
          description: Ok
          content:
            'application/json':
              schema:
                '$ref': '#/components/schemas/cee_application_identity_import_response'
  /policies/cee/{uuid}:
    get:
      tags:
      - Demandes CEE
      summary: Rechercher une demande CEE
      description: |
        L'API peut √™tre utilis√©e jusqu'√† 20.000x par minute.

      operationId: policy:cee:find
      parameters:
        - name: uuid
          in: path
          required: true
          description: UUID de la demande
          schema:
            '$ref': '#/components/schemas/cee_application_uuid'
      responses:
        '200':
          description: La demande a √©t√© trouv√©e et appartient √† l'op√©rateur.
          content:
            'application/json':
              schema:
                '$ref': '#/components/schemas/cee_application'
        '404':
          description: La demande n'a pas √©t√© trouv√©e
        '403':
          description: La demande ne peut aboutir car celle-ci appartient √† un autre op√©rateur
    delete:
      tags:
      - Demandes CEE
      summary: Supprimer une demande CEE
      description: |
        L'API peut √™tre utilis√©e jusqu'√† 20.000x par minute.

      operationId: policy:cee:delete
      parameters:
        - name: uuid
          in: path
          required: true
          description: UUID de la demande
          schema:
            '$ref': '#/components/schemas/cee_application_uuid'      
      responses:
        '204':
          description: La demande a √©t√© trouv√©e et a bien √©t√© supprim√©e.
        '404':
          description: La demande n'a pas √©t√© trouv√©e.
        '403':
          description: La demande ne peut aboutir car celle-ci appartient √† un autre op√©rateur.
