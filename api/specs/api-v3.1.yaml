openapi: 3.0.3
info:
  title: Registre de preuve de covoiturage - Documentation technique
  version: '3.1'
  termsOfService: 'https://doc.covoiturage.beta.gouv.fr/nos-services/le-registre-de-preuve-de-covoiturage/cgu-conditions-generales-dutilisation'
  contact:
    name: √âquipe technique du RPC
    email: technique@covoiturage.beta.gouv.fr
  license:
    name: Licence Apache-2.0
    url: 'https://raw.githubusercontent.com/betagouv/preuve-covoiturage/main/LICENSE'
  description: |
    ## Le produit

    Le Registre de preuve de covoiturage est un service public num√©rique
    d√©velopp√© par le Minist√®re de l'√âcologie et l'Agence de la transition
    √©cologique (ADEME). Il fait partie de l'incubateur des Startups d'√âtat :
    la communaut√© [beta.gouv.fr](https://beta.gouv.fr/)

    ## A qui s'adresse cette documentation ?

    Cette documentation technique est destin√©e aux personnes :

    - souhaitant se connecter √† l'API pour envoyer des preuves, g√©n√©rer des attestations ;
    - souhaitant comprendre l'organisation globale de l'application ;
    - souhaitant installer, ex√©cuter, tester, modifier le code ;
    - souhaitant soumettre des correctifs ou des am√©liorations ;
    - souhaitant comprendre les m√©thodes de calcul utilis√©es pour les incitations ;
    - souhaitant effectuer des tests de s√©curit√© sur l'application ;
    - ...

    sinon, la [documentation g√©n√©rale du produit](https://doc.covoiturage.beta.gouv.fr/) est peut-√™tre pour vous.

    ## √âcosyst√®me

    Plusieurs services sont g√©r√©s par l'√©quipe du Registre de preuve de covoiturage :

    - [L'observatoire national du covoiturage](https://observatoire.covoiturage.gouv.fr/) permet de suivre l'√©volution des pratiques du covoiturage courte distance.
    - [Le site vitrine](https://covoiturage.beta.gouv.fr/) pr√©sente le produit ;
    - [La documentation g√©n√©rale](https://doc.covoiturage.beta.gouv.fr/) ;
    - [L'application](https://app.covoiturage.beta.gouv.fr/) permet aux op√©rateurs et aux territoires de g√©rer les campagnes ;
    - [Les statistiques](https://app.covoiturage.beta.gouv.fr/stats) des chiffres cl√©s de la Startup d'√âtat ;
    - [Le statut des applications](https://status.covoiturage.beta.gouv.fr/) pour suivre les incidents et l'accessibilit√© des services ;
    - [Le g√©n√©rateur d'attestations sur l'honneur](https://attestation.covoiturage.beta.gouv.fr/) permet aux personnes qui covoiturent de produire facilement un document pour leur employeur dans le but de profiter du Forfait Mobilit√©s Durables.

    ## Langues

    Cette documentation est principalement r√©dig√©e en fran√ßais afin d'√©viter
    de traduire des termes pr√©cis du langage administratif. Les parties
    relatives au code de l'application peuvent √™tre en anglais.

    ## √âdition

    Le code source de l'application est ouvert. Vous pouvez soumettre des
    corrections ou des propositions d'√©volution. Pour cela, vous devez avoir
    un compte sur la plateforme [Github](https://github.com/).

    ## Code source

    Le code source de l'application est ouvert et disponible sur
    [Github](https://github.com/betagouv/preuve-covoiturage/).

    ## Licence et version
servers:
  - url: 'https://api.covoiturage.beta.gouv.fr/v3.1'
    description: Production
  - url: 'https://api.demo.covoiturage.beta.gouv.fr/v3.1'
    description: Pr√©-production
paths:
  /journeys:
    post:
      operationId: 'acquisition:create'
      summary: Envoyer un trajet
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                operator_journey_id:
                  $ref: '#/components/schemas/operator_journey_id'
                operator_trip_id:
                  $ref: '#/components/schemas/operator_trip_id'
                operator_class:
                  $ref: '#/components/schemas/operator_class'
                incentives:
                  $ref: '#/components/schemas/incentives'
                licence_plate:
                  $ref: '#/components/schemas/licence_plate'
                start:
                  description: Position g√©ographique et date de d√©part du passager
                  $ref: '#/components/schemas/time_geopoint'
                end:
                  description: Position g√©ographique et date d'arriv√©e du passager
                  $ref: '#/components/schemas/time_geopoint'
                distance:
                  $ref: '#/components/schemas/distance'
                driver:
                  $ref: '#/components/schemas/driver'
                passenger:
                  $ref: '#/components/schemas/passenger'
              additionalProperties: false
              required:
                - operator_journey_id
                - operator_trip_id
                - incentives
                - operator_class
                - start
                - end
                - distance
                - driver
                - passenger
      responses:
        '201':
          description: OK. Le trajet a bien √©t√© enregistr√©.
          content:
            application/json:
              example:
                id: 1
                jsonrpc: '2.0'
                result:
                  meta: null
                  data:
                    operator_journey_id: cb82956e-3833-4925-9891-47d9b2ba0186
                    created_at: '2021-01-01T00:00:00+0100'
        '400':
          $ref: '#/components/responses/http_400_rpc'
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
        '409':
          description: |
            Le trajet est d√©j√† enregistr√©.
        '422':
          description: |
            Le payload envoy√© ne respecte pas le contrat d'interface / les Conditions G√©n√©rales d'Utilisation.
            Le trajet n'a pas √©t√© enregistr√© par le Registre de Preuve de Covoiturage.
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    example: 1
                  jsonrpc:
                    type: string
                    enum:
                      - '2.0'
                  error:
                    type: object
                    properties:
                      data:
                        type: object
                        properties:
                          rejected_reasons:
                            $ref: '#/components/schemas/rejected_reasons'
                        required:
                          - rejected_reasons
                      code:
                        type: integer
                        enum:
                          - -32422
                      message:
                        type: string
                        enum:
                          - Unprocessable Request
      tags:
        - Trajets courte distance
    get:
      summary: Liste des trajets
      description: |
        La liste est toujours ordonn√©e de mani√®re ant√©-chronologique.

        Les trajets apparaissent au plus tard 24h apr√®s leur envoi.

        Dans le cadre de la fraude inter-op√©rateurs, les op√©rateurs sont tenus
        de v√©rifier le statut du trajet au plus t√¥t 48h apr√®s la r√©alisation de
        celui-ci.

        Ces trajets peuvent √™tre list√©s en passant un param√®tre `status` √†
        `fraud_error`.
      parameters:
        - name: status
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/status'
          example: ok
        - name: limit
          in: query
          schema:
            $ref: '#/components/schemas/limit'
            default: 50
        - name: start
          in: query
          description: Date de d√©but de recherche
          required: false
          schema:
            $ref: '#/components/schemas/datetime'
            default: 'now-7d'
            minimum: 'now-90d'
        - name: end
          in: query
          description: Date de fin de recherche
          required: false
          schema:
            $ref: '#/components/schemas/datetime'
            default: 'now'
        - name: offset
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/offset'
            default: 0
      responses:
        '200':
          $ref: '#/components/responses/http_200'
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required:
                    - operator_journey_id
                  properties:
                    operator_journey_id:
                      $ref: '#/components/schemas/operator_journey_id'
      tags:
        - Trajets courte distance
  '/journeys/{operator_journey_id}':
    parameters:
      - name: operator_journey_id
        in: path
        required: true
        schema:
          $ref: '#/components/schemas/operator_journey_id'
    get:
      operationId: 'acquisition:status'
      summary: V√©rifier le statut d'un trajet envoy√©
      responses:
        '200':
          description: |
            OK
            Le trajet a √©t√© trouv√© et son statut est retourn√©.
            Attention, le trajet peut √™tre en erreur malgr√© le code 200, v√©rifiez le statut retourn√©.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/status'
                  operator_journey_id:
                    $ref: '#/components/schemas/operator_journey_id'
                  created_at:
                    description: 'la date d''enregistrement du trajet ou √† d√©faut d''enregistrement, la date de l''erreur d''enregistrement'
                    type: string
                    format: date-time
                  rejected_reasons:
                    $ref: '#/components/schemas/rejected_reasons'
                required:
                  - status
                  - operator_journey_id
                  - created_at
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
        '404':
          description: Le trajet n'a pas √©t√© trouv√©
          content:
            application/json:
              example:
                code: 404
                error: Not found
      tags:
        - Trajets courte distance
    patch:
      operationId: 'acquisition:update'
      summary: Mettre √† jour un trajet
      description: |
        Permet de mettre √† jour un trajet qui est en erreur suite √† un probl√®me
        de validation sur le payload.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                operator_trip_id:
                  $ref: '#/components/schemas/operator_trip_id'
                operator_class:
                  $ref: '#/components/schemas/operator_class'
                incentives:
                  $ref: '#/components/schemas/incentives'
                start:
                  $ref: '#/components/schemas/time_geopoint'
                end:
                  $ref: '#/components/schemas/time_geopoint'
                distance:
                  $ref: '#/components/schemas/distance'
              additionalProperties: false
              required:
                - incentives
                - operator_class
                - start
                - end
                - distance
      responses:
        '200':
          $ref: '#/components/responses/http_200'
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
      tags:
        - Trajets courte distance
  '/journeys/{operator_journey_id}/cancel':
    parameters:
      - name: operator_journey_id
        in: path
        description: operator_journey_id of the journey created
        required: true
        schema:
          $ref: '#/components/schemas/operator_journey_id'
    post:
      operationId: 'acquisition:cancel'
      summary: Invalider un trajet envoy√©
      description: |
        Annule un trajet d√©j√† envoy√© dans le RPC.

        S'il d√©tecte un comportement inhabituel ou une fraude av√©r√©e, un
        op√©rateur doit communiquer aupr√®s du service l'invalidation du trajet
        concern√© d√®s lors qu'il est d√©j√† inscrit dans le RPC.
        
        Cette invalidation doit avoir lieu d√®s que l'op√©rateur a connaissance de
        cette irr√©gularit√© √† tout moment.

        Le `code` est un champ libre de 32 caract√®res maximum. Obligatoire.
        
        Le `message` est un champ libre pour expliquer la raison de
        l'invalidation. Optionnel.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                code:
                  type: string
                  pattern: '^[0-9A-Za-z_-]{0,32}$'
                message:
                  type: string
                  maxLength: 512
              additionalProperties: false
              required:
                - code
      responses:
        '200':
          description: |
            OK
            La demande d'invalidation a √©t√© prise en compte
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
        '404':
          description: Le trajet n'a pas √©t√© trouv√©
          content:
            application/json:
              example:
                code: 404
                error: Not found
      tags:
        - Trajets courte distance
  /geo/route:
    get:
      summary: Calcul th√©orique de la distance et de la dur√©e
      parameters:
        - name: start
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/geopoint'
        - name: end
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/geopoint'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  distance:
                    $ref: '#/components/schemas/distance'
                  duration:
                    $ref: '#/components/schemas/duration'
                required:
                  - distance
                  - duration
      tags:
        - G√©ographie
  /geo/point/by_address:
    get:
      summary: Geocoding √† partir d'une adresse lit√©rale
      parameters:
        - name: literal
          in: query
          description: Adresse litt√©rale
          required: true
          schema:
            type: string
          example: '5 rue du Paradis, 75010 Paris'
        - name: country
          in: query
          description: Nom complet du pays
          required: true
          schema:
            type: string
          example: France
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/geopoint'
      tags:
        - G√©ographie
  /geo/point/by_insee:
    get:
      summary: Geocoding √† partir d'un code INSEE
      parameters:
        - name: code
          in: query
          description: |
            Code INSEE commune ou arrondissement de la position.

            Pour les m√©tropoles qui comportent un code INSEE global et des codes
            par arrondissement, utiliser le code arrondissement.
          schema:
            type: string
          example: '91177'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/geopoint'
      tags:
        - G√©ographie
  /exports:
    post:
      operationId: 'export:createVersionThree'
      summary: Exporter des trajets
      description: |
        ## Exporter des trajets en CSV

        Les exports sont conserv√©s 7 jours.

        La cr√©ation d'un export peut prendre plusieurs minutes. Un email est
        envoy√© aux destinataires une fois l'export termin√©.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tz:
                  description: Fuseau horaire
                  type: string
                  example: Europe/Paris
                start_at:
                  description: |
                    Date de d√©but au format ISO. S√©lectionne les trajets >= date
                  type: string
                  format: date-time
                  example: '2024-01-01T00:00:00+0100'
                end_at:
                  description: |
                    Date de fin au format ISO n√©cessairement sup√©rieur √†
                    `start_at`. S√©lectionne les trajets < date
                  type: string
                  format: date-time
                  example: '2024-02-01T00:00:00+0100'
                operator_id:
                  description: Identifiant du ou des op√©rateurs √† exporter
                  type: array
                  items:
                    type: number
                  example: '[1,2,3]'
                  maxItems: 128
                  minItems: 0
                recipients:
                  description: |
                    Liste des adresses email des destinataires de l'export. Ces
                    personnes recevront une notification avec un lien de
                    t√©l√©chargement.
                  type: array
                  items:
                    type: string
                    format: email
                  maxItems: 24
                  minItems: 0
                geo_selector:
                  $ref: '#/components/schemas/geo_selector'
              additionalProperties: false
              required:
                - tz
                - start_at
                - end_at
                - operator_id
      responses:
        '201':
          description: |
            La demande d'export a √©t√© cr√©√©e. Un email sera envoy√© aux
            destinataires avec un lien de t√©l√©chargement une fois l'export termin√©.

            En cas d'erreur, la personne qui a command√© l'export sera notifi√©e,
            ainsi que l'√©quipe technique du RPC.
          content:
            application/json:
              schema:
                type: object
                properties:
                  uuid:
                    type: string
                    format: uuid
                    example: 8a9d2da9-39e3-4db7-be8e-12b4d2179fda
                  target:
                    type: string
                    enum:
                      - operator
                      - territory
                      - opendata
                  status:
                    type: string
                    enum:
                      - pending
                      - running
                      - uploading
                      - uploaded
                      - notify
                      - success
                      - failure
                  start_at:
                    type: string
                    format: date-time
                    example: '2024-01-01T00:00:00+0100'
                  end_at:
                    type: string
                    format: date-time
                    example: '2024-02-01T00:00:00+0100'
                required:
                  - uuid
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
      tags:
        - Export de trajets
  /certificates:
    post:
      operationId: 'certificate:create'
      summary: Cr√©er une attestation
      description: |
        > warn
        > Cette API sera d√©pr√©ci√©e en v3.2 et ne sera pas remplac√©e.

        ## Configuration de la requ√™te

        1. La requ√™te est authentifi√©e avec un [token applicatif](/operateurs/preuves/acces) √† ajouter √† l'ent√™te de la requ√™te : `Authorization: Bearer <token>`
        2. Le fuseau horaire est requis
        2. L'identit√© est requise
        3. Le filtrage g√©ographique est optionnel
        4. Les dates de d√©but et de fin sont optionnelles
        5. La date de fin la plus r√©cente possible est J-6
        6. La date de d√©but la plus ancienne est le 1er janvier de l'ann√©e pr√©c√©dente

        ## Cr√©ation simple

        Les donn√©es requises pour la cr√©ation ne concernent que l'identit√© de la
        personne et le fuseau horaire.

        Par d√©faut, l'attestation sera g√©n√©r√©e pour l'ann√©e pr√©c√©dente sans
        restrictions g√©ographiques.

        Chaque appel, m√™me si les param√®tres sont les m√™mes, entraine la
        cr√©ation d'une attestation unique.

        Les attestations ne peuvent √™tre supprim√©es. [Contactez notre
        √©quipe](mailto:technique@covoiturage.beta.gouv.fr) au besoin.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                identity:
                  $ref: '#/components/schemas/identitycert'
                tz:
                  description: fuseau horaire
                  type: string
                  example: Europe/Paris
                start_at:
                  description: Date de d√©but au format ISO. S√©lectionne les trajet >= date
                  type: string
                  format: date-time
                  example: '2021-01-01T00:00:00+0100'
                end_at:
                  description: Date de fin au format ISO n√©cessairement sup√©rieur √† `start_at`. S√©lectionne les trajets < date
                  type: string
                  format: date-time
                  example: '2021-07-01T00:00:00+0200'
                positions:
                  description: |
                    Pour s√©lectionner des trajets en fonction de leur point de
                    d√©part et d'arriv√©e, il est possible de les pr√©ciser avec la
                    cl√© `positions`.
                    
                    Tous les trajets ayant un d√©part **et** une arriv√©e dans un
                    rayon de `1km` autour des points donn√©s seront inclus √†
                    l'attestation.
                  type: array
                  items:
                    $ref: '#/components/schemas/geopoint'
                  minItems: 2
              additionalProperties: false
              required:
                - identity
                - tz
      responses:
        '201':
          description: OK
          content:
            application/json:
              schema:
                description: |
                  Les donn√©es calcul√©es de l'attestation sont retourn√©es dans la
                  r√©ponse pour permettre leur affichage par votre application.
                  
                  Vous pouvez reconstruire l'URL de validation publique avec
                  l'UUID.
                type: object
                properties:
                  uuid:
                    type: string
                    format: uuid
                    example: 8a9d2da9-39e3-4db7-be8e-12b4d2179fda
                  created_at:
                    type: string
                    format: date-time
                    example: '2020-01-01T00:00:00+0100'
                  meta:
                    type: object
                    properties:
                      tz:
                        type: string
                        example: Europe/Paris
                      positions:
                        type: array
                        items:
                          $ref: '#/components/schemas/geopoint'
                      driver:
                        $ref: '#/components/schemas/certificate_data'
                      passenger:
                        $ref: '#/components/schemas/certificate_data'
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
        '404':
          description: L'identit√© n'a pu √™tre trouv√©e. V√©rifiez les identifiants envoy√©s.
          content:
            application/json:
              example:
                code: 404
                error: Not found
      tags:
        - Attestations op√©rateurs ‚ö†Ô∏è
  '/certificates/{uuid}/attachment':
    parameters:
      - name: uuid
        in: path
        description: Identifiant de l'attestation pr√©c√©demment cr√©√©.
        required: true
        schema:
          type: string
          format: uuid
    post:
      operationId: 'certificate:download'
      summary: T√©l√©charger une attestation
      description: |
        > warn
        > Cette API sera d√©pr√©ci√©e en v3.2 et ne sera pas remplac√©e.

        ## Upload du logo op√©rateur

        Vous pouvez personnaliser le logo op√©rateur pr√©sent sur l'attestation.

        Contrairement aux meta-donn√©es envoy√©es lors de la cr√©ation de
        l'attestation, le logo est configur√© au pr√©alable via le page de profil
        de votre op√©rateur.

        - [Ajouter mon logo en production](https://app.covoiturage.beta.gouv.fr/admin/operator)
        - [Ajouter mon logo pour les tests](https://app.demo.covoiturage.beta.gouv.fr/admin/operator)

        > _Le poids de l'image est de 2Mo maximum et sa taille de 1024x1024 pixels._

        ## T√©l√©chargement

        Une fois l'attestation cr√©√©e en base \(201 created\), on peut
        t√©l√©charger un PDF en y ajoutant des donn√©es permettant une
        identification simplifi√©e de la personne.

        Ces meta-donn√©es optionnelles ne sont pas stock√©es sur nos serveurs,
        elles sont ajout√©es au document g√©n√©r√© √† la vol√©e.

        Le PDF g√©n√©r√© n'est pas stock√© sur nos serveurs. L'appel d'API vous
        renvoie un fichier binaire que vous sauvegardez de votre c√¥t√©. Vous
        pouvez g√©n√©rer le PDF d'une attestation plusieurs fois de suite.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                meta:
                  description: |
                    personnalisation optionnelle de l'en-t√™te
                    omettre 'meta' si pas de personnalisation
                    toutes les propri√©t√©s sont facultatives
                  type: object
                  properties:
                    operator:
                      description: |
                        zone de texte. Maximum de 305 caract√®res
                        Maximum de 6 lignes s√©par√©es par `\n`
                      type: string
                      maxLength: 305
                    identity:
                      type: object
                      properties:
                        name:
                          description: Nom de la personne
                          type: string
                          maxLength: 26
                        content:
                          description: |
                            zone de texte. Maximum de 305 caract√®res
                            Maximum de 6 lignes s√©par√©es par `\n`
                          maxLength: 305
                          type: string
                    note:
                      description: |
                        zone de texte. Maximum de 440 caract√®res
                        Retour √† la ligne automatique (wrap)
                      type: string
              additionalProperties: false
      responses:
        '200':
          description: OK, le fichier binaire est envoy√©
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
        '404':
          description: L'attestation n'a pu √™tre trouv√©e
          content:
            application/json:
              example:
                code: 404
                error: Not found
      tags:
        - Attestations op√©rateurs ‚ö†Ô∏è
  '/certificates/{uuid}':
    parameters:
      - name: uuid
        in: path
        description: Identifiant de l'attestation pr√©c√©demment cr√©√©.
        required: true
        schema:
          type: string
          format: uuid
        example: 9415300a-7a51-4296-96d1-68636e46485d
    get:
      operationId: 'certificate:verify'
      summary: V√©rifier une attestation
      description: |
        > warn
        > Cette API sera d√©pr√©ci√©e en v3.2 et ne sera pas remplac√©e.
      parameters: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  type:
                    type: string
                    enum:
                      - ok
                      - expired
                  uuid:
                    type: string
                    format: uuid
                    example: 8a9d2da9-39e3-4db7-be8e-12b4d2179fda
                  tz:
                    type: string
                    example: Europe/Paris
                  start_at:
                    type: string
                    format: date-time
                    example: '2020-01-01T00:00:00+0100'
                  end_at:
                    type: string
                    format: date-time
                    example: '2020-01-01T00:00:00+0100'
                  created_at:
                    type: string
                    format: date-time
                    example: '2020-01-01T00:00:00+0100'
                  identity:
                    type: object
                    properties:
                      uuid:
                        type: string
                        format: uuid
                  operator:
                    type: object
                    properties:
                      _id:
                        type: integer
                      uuid:
                        type: string
                        format: uuid
                      name:
                        type: string
                  positions:
                    type: array
                    items:
                      $ref: '#/components/schemas/geopoint'
                  driver:
                    $ref: '#/components/schemas/certificate_data'
                  passenger:
                    $ref: '#/components/schemas/certificate_data'
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
        '404':
          description: L'attestation n'a pu √™tre trouv√©e
          content:
            application/json:
              example:
                code: 404
                error: Not found
      tags:
        - Attestations op√©rateurs ‚ö†Ô∏è
  /policies/cee:
    post:
      operationId: 'policy:cee:register'
      summary: Enregistrer une demande CEE
      description: |
        V√©rification compl√®te de l'√©ligibilit√© de l'usager (historique et
        d√©doublonnage) et enregistrement de la demande CEE dans l'API CEE :

        - Si la conformit√© de la demande est valide, une r√©ponse 201 est retourn√©e validant l'enregistrement de la demande.
        - Si une demande a d√©j√† √©t√© enregistr√©e pour l'usager en question, une r√©ponse 409 est retourn√©e avec la date √† laquelle l'enregistrement a √©t√© fait.
        - Si le trajet envoy√© n'est pas trouv√©, une r√©ponse 404 est retourn√©e.

        Ce point d'API est consultable √† `J+7` pour la courte et la longue
        distance, `J` √©tant la date de r√©alisation du trajet.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/short_distance_application'
                - $ref: '#/components/schemas/long_distance_application'
      responses:
        '201':
          description: 'OK, la demande est enregistr√©e'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/cee_application'
        '400':
          description: |
            - "expired" : correspond a un trajet envoy√© "hors d√©lais". Il faut qu'il soit enregistr√© dans le RPC dans les 5 jours qui suivent sa r√©alisation
            - "Date should be before 7 days from now" : correspondant √† un appel √† l'API CEE qui aurait √©t√© fait √† moins de J+7 de la date de fin du trajet
              sur la courte distance et √† moins de J+7 de la date de paiement au conducteur par l'op√©rateur sur le longue distance.
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
        '404':
          description: |
            La demande n'a pas pu aboutir car un trajet √©ligible n'a pas √©t√©
            trouv√© soit parce que l'identifiant envoy√© ne correspond pas √† un
            trajet inscrit dans le RPC, soit parce que celui-ci ne correspond
            pas au crit√®res d'√©ligibilit√©.
            
            Pour rappel, un trajet √©ligible est un trajet:

              - apr√®s le 1er janvier 2023
              - de moins de 80 km
              - dont le d√©part ou l'arriv√©e est en France
              - de classe C
        '409':
          description: |
            Une demande similaire a d√©j√† enregistr√©e.
            
            Si elle a d√©j√† √©t√© enregistr√©e par le m√™me op√©rateur, alors la
            r√©ponse contient l'UUID de la demande, le `journey_id` et le
            `status` si la demande initiale concerne la courte distance.
            
            Dans le cas contraire, seul le champs datetime correspondant √† la
            date de l'op√©ration est renvoy√©.
          content:
            application/json:
              schema:
                type: object
                properties:
                  datetime:
                    description: 'Date de l''op√©ration, en l''occurence date de fin du trajet pour la courte distance et date de paiement pour la longue.'
                    type: string
                    format: datetime
                  uuid:
                    description: UUID V4 de la demande si la demande a d√©j√† √©t√© effectu√©e par l'op√©rateur.
                    type: string
                    format: uuid
      tags:
        - Demandes CEE
  /policies/cee/simulate:
    post:
      operationId: 'policy:cee:simulate'
      summary: Simuler une demande CEE
      description: |
        Possibilit√© de simuler une demande avant la r√©alisation du trajet par un
        usager afin de v√©rifier partiellement la pr√©-√©ligibilit√© de ce dernier
        (v√©rification de l'historique mais pas du d√©doublonnage).

        Sont requis : n¬∞ de permis de conduire, trois premi√®res
        lettres du nom de famille et 8 premiers chiffres du num√©ro de t√©l√©phone.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                driving_license:
                  $ref: '#/components/schemas/driving_license'
                last_name_trunc:
                  $ref: '#/components/schemas/last_name_trunc'
                phone_trunc:
                  $ref: '#/components/schemas/phone_trunc'
                journey_type:
                  $ref: '#/components/schemas/journey_type'
                identity_key:
                  $ref: '#/components/schemas/identity_key'
              additionalProperties: false
              required:
                - last_name_trunc
                - phone_trunc
                - journey_type
      responses:
        '200':
          description: 'OK, la demande est possible'
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
        '409':
          description: Une demande similaire a d√©j√† √©t√© enregistr√©e
          content:
            application/json:
              schema:
                type: object
                properties:
                  datetime:
                    description: Date √† laquelle la demande a √©t√© effectu√©e
                    type: string
                    format: datetime
                  uuid:
                    description: UUID de la demande si la demande a d√©j√† √©t√© effectu√©e par l'op√©rateur.
                    type: string
                    format: uuid
      tags:
        - Demandes CEE
  /policies/cee/import:
    post:
      operationId: 'policy:cee:import'
      summary: Importez des demandes CEE existantes par lot
      description: |
        Envoi par chaque op√©rateur concern√© de l'historique des b√©n√©ficiaires
        d'op√©rations sp√©cifiques sur les 3 ann√©es pr√©c√©dents 2023. Pour chaque
        b√©n√©ficiaire les informations suivantes sont requises : phone_trunc,
        last_name_trunc, datetime et journey_type.
        
        Afin que l'API soit fonctionnelle, les op√©rateurs doivent faire remonter
        l'historique au RPC au plus t√¥t.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/cee_application_import'
              maxItems: 1000
      responses:
        '201':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/cee_application_import_response'
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
      tags:
        - Demandes CEE
  /policies/cee/import/identity:
    post:
      operationId: 'policy:cee:import:identity'
      summary: Importez les cl√©s d'identit√© des demandes CEE existantes par lot
      description: L'API peut √™tre utilis√©e jusqu'√† 20.000x par minute.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/cee_application_identity_import'
              maxItems: 1000
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/cee_application_identity_import_response'
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
      tags:
        - Demandes CEE
  '/policies/cee/{uuid}':
    get:
      operationId: 'policy:cee:find'
      summary: Rechercher une demande CEE
      description: L'API peut √™tre utilis√©e jusqu'√† 20.000x par minute.
      parameters:
        - name: uuid
          in: path
          description: UUID de la demande
          required: true
          schema:
            $ref: '#/components/schemas/cee_application_uuid'
      responses:
        '200':
          description: La demande a √©t√© trouv√©e et appartient √† l'op√©rateur.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/cee_application'
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
          description: La demande ne peut aboutir car celle-ci appartient √† un autre op√©rateur
        '404':
          description: La demande n'a pas √©t√© trouv√©e
      tags:
        - Demandes CEE
    delete:
      operationId: 'policy:cee:delete'
      summary: Supprimer une demande CEE
      description: L'API peut √™tre utilis√©e jusqu'√† 20.000x par minute.
      parameters:
        - name: uuid
          in: path
          description: UUID de la demande
          required: true
          schema:
            $ref: '#/components/schemas/cee_application_uuid'
      responses:
        '204':
          description: La demande a √©t√© trouv√©e et a bien √©t√© supprim√©e.
        '401':
          $ref: '#/components/responses/http_401_rpc'
        '403':
          $ref: '#/components/responses/http_403_rpc'
          description: La demande ne peut aboutir car celle-ci appartient √† un autre op√©rateur.
        '404':
          description: La demande n'a pas √©t√© trouv√©e.
      tags:
        - Demandes CEE
components:
  schemas:
    offset:
      description: Nombre de r√©sultats √† sauter avant de commencer √† retourner des r√©sultats.
      type: number
      minimum: 0
      multipleOf: 1
    total:
      description: Nombre total de r√©sultats disponibles.
      type: number
      minimum: 0
      multipleOf: 1
    limit:
      description: Nombre maximum de r√©sultats √† retourner.
      type: number
      minimum: 0
      multipleOf: 1
    pagination:
      type: object
      properties:
        offset:
          $ref: '#/components/schemas/offset'
        limit:
          $ref: '#/components/schemas/limit'
        total:
          $ref: '#/components/schemas/total'
      additionalProperties: false
      required:
        - offset
        - limit
    operator_trip_id:
      description: |
        Identifiant g√©n√©r√© par l'op√©rateur pour regrouper des trajets (plusieurs
        passagers avec un m√™me conducteur)
      type: string
    operator_class:
      description: |
        Classe de preuve correspondant aux sp√©cifications d√©finies dans
        [Classes de preuve de
        covoiturage](https://doc.covoiturage.beta.gouv.fr/le-registre-de-preuve-de-covoiturage/classes-de-preuve-and-identite/classes-a-b-c)
      enum:
        - A
        - B
        - C
    licence_plate:
      description: Plaque d'immatriculation du v√©hicule
      type: string
    driver:
      description: Informations d'identit√© du conducteur
      type: object
      properties:
        identity:
          $ref: '#/components/schemas/identity'
        revenue:
          description: |
            La somme r√©ellement per√ßue par le conducteur **APR√àS** que toutes
            les incitations (subventions employeurs, promotions op√©rateurs,
            incitations AOM, etc.), contributions des passagers aient √©t√©
            vers√©es et que la commission de l'op√©rateur soit prise.
          type: number
          minimum: 0
          multipleOf: 1
      additionalProperties: false
      required:
        - identity
        - revenue
    passenger:
      description: Informations d'identit√© du passager
      type: object
      properties:
        identity:
          $ref: '#/components/schemas/identity'
        payments:
          $ref: '#/components/schemas/payments'
        contribution:
          description: |
            Co√ªt r√©el total du service pour l'occupant passager en fonction du
            nombre de si√®ges r√©serv√©s **APR√àS** que toutes les possibles
            incitations aient √©t√© vers√©es (subventions employeurs, promotions
            op√©rateurs, incitations AOM, etc).
          type: number
          minimum: 0
          multipleOf: 1
        seats:
          description: Nombre de si√®ges r√©serv√©s par l'occupant passager.
          type: number
          default: 1
          maximum: 8
          minimum: 1
          multipleOf: 1
      additionalProperties: false
      required:
        - identity
        - contribution
    operator_journey_id:
      description: |
        Identifiant unique du trajet envoy√© par l'op√©rateur.
      type: string
      maxLength: 256
      minLength: 1
      pattern: '^[a-z0-9]{1,256}$'
    status:
      description: |
        Statut du trajet tel que :
          - `pending` : le trajet a √©t√© enregistr√© mais n'a pas encore √©t√© trait√©
          - `accepted` : le trajet a correctement √©t√© trait√©
          - `rejected` : le trajet a √©t√© refus√©
          - `canceled` : le trajet a √©t√© annul√© par l'op√©rateur
      type: string
      enum:
        - pending
        - accepted
        - rejected
        - canceled
      example: rejected
    rejected_reasons:
      description: |
        Liste des raisons ayant abouti au rejet du trajet.
      type: array
      items:
        $ref: '#/components/schemas/rejected_reason'
      example:
        - interoperator_too_many_trips_by_day
        - too_many_trips_by_day
    rejected_reason:
      description: |
        note: les champs not√© d'un üì¶ sont d'anciens statut qui pourraientt-√™tre supprim√©s de l'API

        Raisons du rejet du trajet :
        
        # Etiquettes possibles pour non respect de l'OpenAPI :

        - `acquisition_error` : le trajet n'a pas du tout √©t√© enregistr√©
        - `normalization_error` : le trajet a √©t√© enregistr√© mais les donn√©es envoy√©es n'ont pas pu √™tre standardis√©es
        - `validation_error` : les donn√©es envoy√©es ne sont pas valides

        # Etiquettes possibles pour un cas de non respect des CGU :

        - üì¶ `terms_violation_error` : le trajet ne respecte pas les conditions g√©n√©rales d'utilisation
        - `distance_too_short` : le trajet a une distance trop faible (<2 km)
        - `expired` : le trajet a d√©pass√© la date limite d'envoi de 24h apr√®s la date de d√©but du trajet. [Cf: engagement de d√©lais d'envoi par les op√©rateurs](https://doc.covoiturage.beta.gouv.fr/bienvenue/faq-foire-aux-questions#quel-est-le-delai-denvoi-des-preuves-de-covoiturage)
        - `too_close_trips` : le trajet est trop rapproch√© d'un trajet pr√©c√©dent ou suivant r√©alis√© avec la m√™me personne (D√©lai minimum de 30mn entre 2 trajets (operator_trip_id diff√©rent) impliquant un m√™me usager (driver_identity_key ou passenger_identity_key). Sont pris en compte les trajets finissant moins de 30 min avant le d√©part du trajet soumis ou d√©marrant moins de 30 min apr√®s la fin du trajet soumis.
        - `too_many_trips_by_day` : le participant (driver_identity_key ou passenger_identity_key) a fait plus de 4 trajets dans la m√™me journ√©e (4 operator_trip_id maximum par usager et par jour sur la m√™me date de d√©part)

        # Etiquettes relatives √† la detection de fraude inter-op√©rateur :

        - üì¶ `fraud_error` : le trajet a √©t√© enregistr√© et standardis√© mais il a √©t√© consid√©r√© comme frauduleux
        - `interoperator_overlap` : le trajet a √©t√© d√©clar√© chez un autre op√©rateur pour les m√™mes personnes et avec des bornes temporelles qui se chevauchent. (anciennement `interoperator_fraud`)
        - `interoperator_too_close_trips` : le trajet d'un couple d'`identity_key` (passager/ conducteur) est trop rapproch√© (inf√©rieur √† 30 min) d'un trajet pr√©c√©dent impliquant ce m√™me couple sur un autre op√©rateur.
        - `interoperator_too_many_trips_by_day` : le participant (`identity_key`) a fait plus de 4 trajets sur des op√©rateurs diff√©rents dans la m√™me journ√©e.
  
        # Etiquette possible pour une anomalie d√©tect√©e :

        - üì¶ `anomaly_error` : le trajet est incoh√©rent ou physiquement impossible
        - `distance_duration_anomaly`: 1 trajet a √©t√© enregistr√© avec une dur√©e et/ou une distance incoh√©rente. Les r√®gles de detections sont :
          - distance estim√©e par OSRM ou transmises inf√©rieure √† 300m.
          Le trajet est beaucoup trop court en termes de distance.
          - dur√©e estim√©e par OSRM ou transmise inf√©rieure √† 1 minute.
          Le trajet est beaucoup trop court en termes de dur√©e
          - dur√©e estim√©e par OSRM sup√©rieure √† 2,5 fois le temps transmis. Exemple: temps estim√© 25 minutes pour temps transmis de 10 minutes
          Le temps de trajet est trop faible par rapport au plus court chemin determin√© par OSRM, le trajet est consid√©r√© comme physiquement impossible
          - distance estim√©e par OSRM sup√©rieure √† 2.5 fois la distance transmise. Exemple: distance 10 km sur une distance estim√©e 25 km
          La distance du trajet est trop faible par rapport au plus court chemin determin√© par OSRM, le trajet est consid√©r√© comme physiquement impossible
          - distance transmise sup√©rieure √† 4 fois la distance estim√©e OSRM. Exemple: 10 km estim√© pour 40 km transmis
          La distance transmise est tr√®s largement sup√©rieure √† l'estimation. Le seuil est √©lev√© pour prendre en compte d'√©ventuels d√©tours par rapport au plus court chemin
          - dur√©e transmise sup√©rieure √† 7 fois la dur√©e estim√©e. Exemple : 1h estim√© vs 7h transmis
          La dur√©e transmise est tr√®s largement sup√©rieure par rapport √† l'estimation. Le seuil est √©lev√© pour prendre en compte d'√©ventuels embouteillage
        - `temporal_overlap_anomaly` : 2 trajets ont √©t√© d√©clar√©s pour un m√™me op√©rateur et un m√™me passager sur des bornes temporelles qui se chevauchent √† au moins 70%

        # Autres
          - `unknown` : une erreur inconnue a affect√© le trajet
      type: string
      enum:
        # Keep ordering by group, deprecated, alphabetical
        # OpenAPI not respected
        - acquisition_error
        - normalization_error
        - validation_error

        # T&C
        - terms_violation_error
        - distance_too_short
        - expired
        - too_close_trips
        - too_many_trips_by_day
        
        # Interoperator fraud
        - fraud_error
        - interoperator_overlap
        - interoperator_too_close_trips
        - interoperator_too_many_trips_by_day

        # Anomaly errors
        - anomaly_error
        - distance_duration_anomaly
        - temporal_overlap_anomaly

        # Other errors
        - unknown
      example:
        - interoperator_too_many_trips_by_day
        
    duration:
      description: Dur√©e en secondes
      type: number
      maximum: 36000
      minimum: 0
      multipleOf: 1
    distance:
      description: Distance en m√®tres
      type: number
      maximum: 1000000
      minimum: 0
      multipleOf: 1
    incentives:
      description: |
        Tableau reprenant la liste compl√®te des incitations appliqu√©es (ordre
        d'application, montant, identifiant de l'incitateur). Si aucune
        incitation, envoyer un tableau vide.

        ## Ordre par d√©faut

        Par d√©faut, l'ordre d'application des politiques incitatives est le suivant :
        
        1. Territoire (AOM, R√©gion, ...)
        2. Sponsors (incitations employeur, CE, etc.)
        3. Op√©rateur (op√©ration promotionnelle, offres, etc.)
      type: array
      items:
        type: object
        additionalProperties: false
        required:
          - index
          - amount
          - siret
        properties:
          index:
            description: Ordre d'application de l'incitation
            type: number
            example: 0
            minimum: 0
            multipleOf: 1
          amount:
            description: Montant de l'incitation en centimes d'euros
            type: number
            example: 100
            minimum: 0
            multipleOf: 1
          siret:
            description: |
              Num√©ro de SIRET de l'entit√© qui finance l'incitation.
              Le SIRET est un identifiant unique par structure juridique.
              Il est compos√© de 14 chiffres.
            type: string
            example: '11000101300017'
    payments:
      description: |
        Z√©ro, une ou plusieurs m√©thodes de paiement utilis√©es (ex. carte
        employeur pr√©charg√©e permettant de payer directement le covoiturage sur
        une application).
        
        > info
        > La prise en charge des frais de transports personnel (carburant et
        > forfait mobilit√©) pourra prendre la forme d'une solution de paiement
        > sp√©cifique, d√©mat√©rialis√©e et pr√©pay√©e, intitul√©e ¬´ titre-mobilit√© ¬ª.
        >
        > Ainsi, il appara√Æt comme pertinent de d√©tailler la solution de paiement
        > utilis√©e dans le cadre d'un trajet covoitur√©, s'il s'agit de
        > Titre-Mobilit√©.
      type: array
      items:
        type: object
        additionalProperties: false
        required:
          - index
          - siret
          - type
          - amount
        properties:
          index:
            description: Ordre d'application
            type: number
            example: 0
            minimum: 0
            multipleOf: 1
          amount:
            description: Montant du paiement en centimes d'euros
            type: number
            example: 100
            minimum: 0
            multipleOf: 1
          siret:
            description: Num√©ro de SIRET du payeur
            type: string
            example: '11000101300017'
          type:
            description: Nom du titre
            type: string
    lat:
      description: Latitude comprise entre 90deg et -90deg d√©cimaux en datum WSG-84
      type: number
      example: 47.682821
    lon:
      description: Longitude comprise entre 180deg et -180deg d√©cimaux en datum WSG-84
      type: number
      example: -0.557483
    geopoint:
      description: |
        Position g√©ographique au format WSG-84
      type: object
      properties:
        lat:
          $ref: '#/components/schemas/lat'
        lon:
          $ref: '#/components/schemas/lon'
      additionalProperties: false
      required:
        - lat
        - lon
    geo_selector:
      description: S√©lecteur g√©ographique par d√©coupage administratif
      type: object
      properties:
        arr:
          type: array
          items:
            type: string
            description: Code consolid√© de la zone g√©ographique
        com:
          type: array
          items:
            type: string
            description: Code INSEE de la commune
        epci:
          type: array
          items:
            type: string
            description: Code INSEE de l'EPCI
        aom:
          type: array
          items:
            type: string
            description: SIRET de l'AOM
        reg:
          type: array
          items:
            type: string
            description: SIRET de la r√©gion
        dep:
          type: array
          items:
            type: string
            description: Code INSEE du d√©partement
      example:
        aom:
          - '200067652'
      additionalProperties: false
      maxProperties: 8
      minProperties: 0
    datetime:
      description: |
        Date et heure du d√©part/arriv√©e du passager au format ISO 8601. L'heure
        est exprim√©e en UTC (YYYY-MM-DDThh:mm:ssZ)
        
        L'heure est exprim√©e en UTC \(Coordinated Universal Time\). UTC n'est
        pas ajust√© sur l'heure d'√©t√© et hiver !
      type: string
      format: date-time
      example: '2021-01-01T11:00:00Z'
    time_geopoint:
      type: object
      properties:
        datetime:
          $ref: '#/components/schemas/datetime'
        lat:
          $ref: '#/components/schemas/lat'
        lon:
          $ref: '#/components/schemas/lon'
      additionalProperties: false
      required:
        - datetime
        - lat
        - lon
    identity:
      description: |
        Ces donn√©es personnelles permettent d'identifier la personne effectuant
        le covoiturage afin de pouvoir comptabiliser ses trajets et lui
        distribuer des incitations en fonction des politiques applicables.
        
        Deux options sont disponibles pour la transmission du num√©ro de
        t√©l√©phone :
        
        - Num√©ro complet au format ITU E.164 (phone) (ex. +33601020304, +590690101010)
        - Num√©ro au format ITU E.164 tronqu√© des 2 derniers chiffres (phone_trunc) (ex. +336010203, +5906901010) + identifiant unique de l'op√©rateur (operator_user_id)
      type: object
      properties:
        identity_key:
          $ref: '#/components/schemas/identity_key'
        travel_pass:
          $ref: '#/components/schemas/travel_pass'
        phone:
          $ref: '#/components/schemas/phone'
        phone_trunc:
          $ref: '#/components/schemas/phone_trunc'
        application_timestamp:
          $ref: '#/components/schemas/application_timestamp'
        driving_license:
          $ref: '#/components/schemas/driving_license'
        operator_user_id:
          $ref: '#/components/schemas/operator_user_id'
        over_18:
          $ref: '#/components/schemas/over_18'
      additionalProperties: false
      required:
        - operator_user_id
        - identity_key
        - phone_trunc
    identity_key:
      description: |
        Correspond au SHA d'une cha√Æne concat√©n√©e tel que : `sha256({phone_number}-{last_name})` o√π :

        - `phone_number` correspond au num√©ro de t√©l√©phone complet au format international sans espace ni tiret. Exemple : `+33601020304`
        - `last_name` correspond au nom de famille complet en majuscule, sans accent ni tiret ni apostrophe :
           Regexp: `[A-Z ]*`
        
        Exemple, M. D'H√©r√ªg-de-l'H√©rault ayant le num√©ro 07 01 02 03 04 doit √™tre formatt√© comme suit `+33701020304-D HERUG DE L HERAULT`
      type: string
      maxLength: 64
      minLength: 64
    travel_pass:
      description: |
        Num√©ro de carte de transport (TCL, Navigo, Trabool, etc.) de l'occupant.
        
        Obligatoire si l'information est disponible.

        Actuellement support√©: navigo
      type: object
      properties:
        name:
          description: Nom du titre
          example: navigo
          enum:
            - navigo
        user_id:
          description: Num√©ro de carte de transport
          type: string
          example: 00-MFR-6782929
      additionalProperties: false
      required:
        - name
        - user_id
    phone:
      description: Num√©ro au format ITU E.164
      type: string
      example: '+33601020304, +590690101010'
    phone_trunc:
      description: Num√©ro de t√©l√©phone au format ITU-T E.164 tronqu√© des 2 derniers chiffres
      type: string
      example: '+336010203'
      maxLength: 14
      minLength: 10
      pattern: '^\+[0-9]{8,12}$'
    last_name_trunc:
      description: |
        Correspond aux trois premi√®rs caract√®res du nom de famille complet en majuscule, sans accent ni tiret ni apostrophe. Dans le cas o√π le nom comporterait moins de 3 lettres, compl√©ter avec des espaces.
        Ex 1: M. D'H√©r√ªg-de-l'H√©rault => "D H"
        Ex 2: M. T√¥ => "TO "
      type: string
      maxLength: 3
      minLength: 3
      pattern: '^[A-Z ]{3}$'
    application_timestamp:
      description: Date de signature de l'engagement par le demandeur.
      type: string
      format: datetime
    driving_license:
      description: |
        Num√©ro de permis de conduire (√©galement appel√© _driving_license_)
        cf https://permisdeconduire.ants.gouv.fr/tout-savoir-sur-le-permis/le-numero-de-dossier-sur-un-permis-au-format-carte-bancaire
      oneOf:
        - type: string
          description: Num√©ro de permis de conduire compos√© de 12 chiffres apr√®s 1975.
          example: '051227308989'
          pattern: '^[0-9]{12}$'
          minLength: 12
          maxLength: 12
        - type: string
          description: Num√©ro de permis de conduire compos√© de 1 √† 15 caract√®res suivis de 4 chiffres avant 1975.
          example: '822146819'
          pattern: '^[A-Z0-9]{1,15}[0-9]{4}$'
          minLength: 5
          maxLength: 19
        - type: string
          description: Num√©ro de permis de conduire plus anciens compos√© de 1 √† 15 caract√®res.
          example: 123456A
          pattern: '^[A-Z0-9]{1,15}$'
          minLength: 1
          maxLength: 15
        - type: string
          description: Num√©ro de permis √©tranger pr√©fix√© de l'indicatif '99-'.
          example: 99-X23836
          pattern: ^99-.*$
          minLength: 4
          maxLength: 64
    operator_user_id:
      description: Identifiant de l'utilisateur chez l'op√©rateur. Obligatoire.
      type: string
      example: d2e8a6c4-9e3a-4b6f-8e8d-9f7a6b5c4d3e
    over_18:
      description: |
        Applicable seulement au passager.

          - `true` si majeur
          - `false` si mineur
          - `null` si non fourni

        > info
        > De nombreuses campagnes utilisent cette information pour s'assurer que les b√©n√©ficiaires d'incitations sont majeures. La valeur `NULL` les exclues.
      enum:
        - true
        - false
        - null
    journey_type:
      type: string
      enum:
        - short
        - long
    long_distance_application:
      type: object
      properties:
        journey_type:
          type: string
          enum:
            - long
        identity_key:
          $ref: '#/components/schemas/identity_key'
        driving_license:
          $ref: '#/components/schemas/driving_license'
        last_name_trunc:
          $ref: '#/components/schemas/last_name_trunc'
        phone_trunc:
          $ref: '#/components/schemas/phone_trunc'
        datetime:
          description: Date de partage des frais.
          type: string
          format: datetime
        application_timestamp:
          $ref: '#/components/schemas/application_timestamp'
      additionalProperties: false
      required:
        - journey_type
        - identity_key
        - driving_license
        - last_name_trunc
        - phone_trunc
        - datetime
        - application_timestamp
    short_distance_application:
      type: object
      properties:
        journey_type:
          type: string
          enum:
            - short
        identity_key:
          $ref: '#/components/schemas/identity_key'
        driving_license:
          $ref: '#/components/schemas/driving_license'
        last_name_trunc:
          $ref: '#/components/schemas/last_name_trunc'
        operator_journey_id:
          $ref: '#/components/schemas/operator_journey_id'
        application_timestamp:
          $ref: '#/components/schemas/application_timestamp'
      additionalProperties: false
      required:
        - journey_type
        - identity_key
        - driving_license
        - last_name_trunc
        - operator_journey_id
        - application_timestamp
    identitycert:
      description: |
        L'identit√© peut √™tre pass√©e de 3 mani√®res diff√©rentes :

        1. `phone` : le num√©ro de t√©l√©phone complet au format ISO
        2. `phone_trunc` + `operator_user_id` : le num√©ro de t√©l√©phone tronqu√© plus votre identifiant utilisateur
        3. `operator_user_id` : votre identifiant utilisateur uniquement (valable uniquement si vous avez transmis des trajets avec le couple `phone_trunc` + `operator_user_id`)
      type: object
      properties:
        phone:
          $ref: '#/components/schemas/phone'
        phone_trunc:
          $ref: '#/components/schemas/phone_trunc'
        operator_user_id:
          $ref: '#/components/schemas/operator_user_id'
      additionalProperties: false
    certificate_data:
      type: object
      properties:
        total:
          type: object
          properties:
            trips:
              type: integer
            week_trips:
              type: integer
            weekend_trips:
              type: integer
            distance:
              $ref: '#/components/schemas/distance'
            amount:
              description: montant en centimes d'euros
              type: number
        trips:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum:
                  - driver
                  - passenger
              datetime:
                type: string
                format: date-time
              trips:
                type: integer
              distance:
                $ref: '#/components/schemas/distance'
              amount:
                description: montant en centimes d'euros
                type: number
      additionalProperties: false
    cee_application_import:
      description: Pr√©c√©dente demande de CEE
      type: object
      properties:
        journey_type:
          $ref: '#/components/schemas/journey_type'
        phone_trunc:
          $ref: '#/components/schemas/phone_trunc'
        last_name_trunc:
          $ref: '#/components/schemas/last_name_trunc'
        datetime:
          description: Date d'engagement de l'op√©ration concern√©e.
          type: string
          format: datetime
      additionalProperties: false
      required:
        - phone_trunc
        - last_name_trunc
        - datetime
        - journey_type
    cee_application_identity_import:
      description: |
        Pr√©c√©dente demande de CEE.
        
        S'il s'agit d'une op√©ration sp√©cifique, le payload est le m√™me que sur
        l'import, en ajoutant le champs `"cee_application_type": "specific"`.
        
        S'il s'agit d'une op√©ration standaris√©e, il convient d'envoyer l'UUID de
        la demande tel que : 
        ```
        {
          "cee_application_type": "standardized",
          "cee_application_uuid": "{{uuid de la demande}}",
          "identity_key": "{{identity_key}}"
        }
        ```
      type: object
      properties:
        cee_application_type:
          $ref: '#/components/schemas/cee_application_type'
        cee_application_uuid:
          $ref: '#/components/schemas/cee_application_uuid'
        identity_key:
          $ref: '#/components/schemas/identity_key'
        journey_type:
          $ref: '#/components/schemas/journey_type'
        phone_trunc:
          $ref: '#/components/schemas/phone_trunc'
        last_name_trunc:
          $ref: '#/components/schemas/last_name_trunc'
        datetime:
          description: Date d'engagement de l'op√©ration concern√©e.
          type: string
          format: datetime
      additionalProperties: false
      oneOf:
        - required:
            - cee_application_type
            - cee_application_uuid
            - identity_key
        - required:
            - cee_application_type
            - identity_key
            - phone_trunc
            - last_name_trunc
            - journey_type
            - datetime
    cee_application_identity_import_response:
      description: Retour de la requ√™te d'import des demandes CEE en batch
      type: object
      properties:
        imported:
          description: Nombre de demandes import√©es avec succ√®s
          type: number
          maximum: 1000
          minimum: 0
        failed:
          description: Nombre de demandes non import√©es
          type: number
          maximum: 1000
          minimum: 0
        failed_details:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/cee_application_identity_import'
              - type: object
                required:
                  - error
                properties:
                  error:
                    type: string
          maxItems: 1000
          minItems: 0
      additionalProperties: false
      required:
        - imported
        - failed
        - failed_details
    cee_application_import_response:
      description: Retour de la requ√™te d'import des demandes CEE en batch
      type: object
      properties:
        imported:
          description: Nombre de demandes import√©es avec succ√®s
          type: number
          maximum: 1000
          minimum: 0
        failed:
          description: Nombre de demandes non import√©es
          type: number
          maximum: 1000
          minimum: 0
        failed_details:
          type: array
          items:
            allOf:
              - $ref: '#/components/schemas/cee_application_import'
              - type: object
                required:
                  - error
                properties:
                  error:
                    type: string
          maxItems: 1000
          minItems: 0
      additionalProperties: false
      required:
        - imported
        - failed
        - failed_details
    cee_application_type:
      description: Type de demande CEE
      type: string
      enum:
        - specific
        - standardized
    cee_application_uuid:
      description: UUID de la demande
      type: string
      format: uuid
    cee_application:
      description: Demande CEE
      type: object
      properties:
        datetime:
          description: |
            Date de l'op√©ration, en l'occurence date de fin du trajet pour la
            courte distance et date de paiement pour la longue.
          type: number
        uuid:
          $ref: '#/components/schemas/cee_application_uuid'
        journey_id:
          description: Num√©ro de trajet interne au RPC correspondant √† l'`operator_journey_id` envoy√©
          type: number
        status:
          description: Statut du trajet correspondant √† l'`operator_journey_id` envoy√©.
          type: string
        token:
          description: |
            `signature(sha512([SIRET_OPERATEUR]/[journey_type]/[driving_license]//[DATETIME UTC]))`
          type: string
          example: signature(sha512(13002526500013/short/051227308989/2022-11-22T08:54:19Z))
      additionalProperties: false
      required:
        - datetime
        - uuid
        - token
  responses:
    http_200:
      description: OK
    http_400_rpc:
      description: Requ√™te invalide
      content:
        application/json:
          example:
            id: 1
            jsonrpc: '2.0'
            error:
              data: 'data/driver/identity/phone_trunc must match format "phonetrunc", data/driver/identity/phone_trunc must pass "macro" keyword validation'
              code: -32602
              message: Invalid params
    http_401_rpc:
      description: Non authentifi√©. Le token applicatif est manquant ou invalide.
      content:
        application/json:
          example:
            id: 1
            jsonrpc: "2.0"
            error:
              data: "Unauthorized application"
              code: -32501
              message: "Unauthorized Error"
    http_403_rpc:
      description: Non autoris√©
      content:
        application/json:
          example:
            id: 1
            jsonrpc: "2.0"
            error:
              data: "Invalid permissions"
              code: -32503
              message: "Forbidden Error"
  securitySchemes:
    token:
      type: http
      scheme: bearer
      bearerFormat: JWT
tags:
  - name: Trajets courte distance
    description: |
      L'API Trajets permet aux op√©rateurs de covoiturage d'envoyer des trajets
      (`journey`) au Registre, de les lister, de v√©rifier leur √©tat, de les
      mettre √† jour ou de les invalider.

      Un trajet est un couple passager.√®re / conducteur.rice ayant des points et
      de horaires de d√©part et d'arriv√©e. Si une conductrice covoiture avec
      plusieurs passag√®res, plusieurs trajets sont d√©clar√©s.

      ### D√©lais et v√©rifications

      Les d√©lais √† observer sont les suivants :

      - 0h : date et heure de d√©part du trajet passager ;
      - 0h - 24h : d√©lai pour envoyer le trajet au RPC ;
      - 0h - 48h : possibilit√© de mettre √† jour ou invalider un trajet ;
      - 48h - J+5 : phase de traitement du trajet par le RPC.

      Les trajets envoy√©s apr√®s 24h seront refus√©s.

      Le statut ne peut plus changer apr√®s 48h.

      La validation des trajets est effectu√©e selon 2 processus : un synchrone
      qui retourne des erreurs imm√©diatement lors de l'envoi et un asynchrone qui
      met √† jour le statut du trajet lors de la phase de traitement.

      > info
      > En cas d'indisponibilit√© du ou des services, le trajet est consid√©r√©
      > automatiquement valid√© apr√®s 48h.

      ### Unit√©s de mesure

      Les unit√©s utilis√©es pour les valeurs num√©riques sont :

      - **centimes d'Euros** pour les montants financiers (100 = 1‚Ç¨)&nbsp;;
      - **m√®tres** pour les distances (2500 = 2,5km)&nbsp;;
      - **secondes** pour les dur√©es (3600 = 1h).

      ### Donn√©es financi√®res

      Le principe est de coller au plus pr√®s avec la r√©alit√© comptable
      \(transaction usager\) et d'avoir suffisamment d'informations pour
      recalculer le co√ªt initial du trajet.

      Ainsi, les propri√©t√©s `passenger.contribution` et `driver.revenue`
      combin√©es au tableau `incentives` doivent permettre ce calcul.

      Ceci afin de s'assurer du respect de la d√©finition du covoiturage et de la
      bonne application des politiques d'incitation g√©r√©es par le RPC.

      ## D√©tection de fraude

      Dans le cadre de la fraude inter op√©rateurs, les op√©rateurs sont tenus de
      v√©rifier le statut du trajet au plus t√¥t 24h apr√®s la r√©alisation de
      celui-ci.

      Ces trajets seront retourn√©s avec un champs `status` √† `fraud_error` et un
      label dans `fraud_error_labels` √† `interoperator_fraud`.

      L'algorithme de d√©tection de fraude inter op√©rateurs est appliqu√© sur tous
      les trajets envoy√©s.

      ## D√©tection d'anomalie

      - Le trajet est incoh√©rent ou physiquement impossible.
      - Le trajet envoy√© rentre en conflit avec un autre sur plan temporel ou spacial

      _Voir la section du schema `anomaly_label` pour plus de d√©tails._
  - name: Demandes CEE
    description: |
      L'API Demandes CEE permet aux op√©rateurs de covoiturage de v√©rifier
      l'√©ligibilit√© d'un trajet √† une demande de prime CEE, de v√©rifier le
      d√©doublonnage et de r√©cup√©rer des donn√©es n√©cessaires √† la constitution
      du dossier avant envoi au PNCEE.

      [En savoir plus](/topic/topic-demandes-cee)
  - name: Export de trajets
    description: |
      L'API Export permet de t√©l√©charger les donn√©es des trajets avec des informations suppl√©mentaires
      par rapport aux fichiers disponibles en Open Data.

      Les donn√©es export√©es sont filtr√©es en fonction de l'utilisateur qui les exporte :

      - Les op√©rateurs de covoiturage peuvent exporter les trajets de leurs
        propres utilisateurs sur tous les territoires.
      - Les territoires peuvent exporter les trajets de tous les op√©rateurs sur
        leur territoire et ont acc√®s √† l'op√©rateur du trajet.
  - name: Attestations op√©rateurs ‚ö†Ô∏è
    description: |
      L'API Attestations permet de g√©n√©rer des attestations de covoiturage pour
      les op√©rateurs de covoiturage afin qu'ils les int√®grent dans leur
      application.

      > ‚ö†Ô∏è Cette API sera d√©pr√©ci√©e en v3.2 et ne sera pas remplac√©e.
  - name: G√©ographie
    description: |
      Requ√™tes g√©ographiques.
security:
  - token: []
x-topics:
  - title: Authentication
    content: |
      Le token applicatif donn√© lors de la cr√©ation de l'application doit √™tre
      envoy√© dans les Headers des requ√™tes HTTP envoy√©e au serveur :

      ```
      Authorization: Bearer {token}
      ```

      Le token est au format JWT a dur√©e de vie longue. Il est recommand√© de le
      changer r√©guli√®rement.
  - title: D√©finitions
    content: |
      #### Acronymes utilis√©s dans la documentation :

      - **RPC** : Registre de preuve de covoiturage
      - **CEE** : Cr√©dits d'Economie d'Energie
      - **PNCEE** : P√¥le National des Cr√©dits d'Economie d'Energie
      - **SIRET** : Syst√®me d'Identification du R√©pertoire des √âtablissements
      - **EPCI** : √âtablissement Public de Coop√©ration Intercommunale
      - **AOM** : Autorit√© Organisatrice de la Mobilit√©
      - **OSRM** : Open Source Routing Machine
      - **JWT** : JSON Web Token
      - **WSG-84** : World Geodetic System 1984

      #### Concepts utilis√©s :

      - **Op√©rateur de covoiturage** : entit√© qui propose un service de covoiturage
      - **Territoire** : entit√© qui propose des campagnes de covoiturage (AOM, EPCI, ...)
      - **Trajet** : d√©placement effectu√© par un conducteur et un passager
                     (on parle aussi de couple conducteur/passager) ou de `journey`
      - **Journey ID** : identifiant unique d'un trajet assign√© par le RPC
      - **Operator Journey ID** : identifiant unique d'un trajet assign√© par l'op√©rateur
      - **Trip** : regroupement de plusieurs trajets effectu√©s par un conducteur au sein du m√™me v√©hicule.
      - **Operator Trip ID** : identifiant unique d'un trip assign√© par l'op√©rateur
  - title: Connexion √† l'API
    content: |
      Envoyer un trajet de covoiturage √† l'API du Registre de Preuve de Covoiturage n√©cessite que plusieurs crit√®res soient remplis.

      1. Une entit√© ‚Äú**op√©rateur de covoiturage**‚Äù est cr√©√©e sur l'application du Registre.
      2. Un utilisateur appartenant √† cet op√©rateur de covoiturage est **administrateur**.
      3. L'administrateur op√©rateur **cr√©e un token applicatif**.
      4. Ce token applicatif est **install√© sur le serveur de l'op√©rateur** qui va envoyer les donn√©es et sera pass√© dans le *Header* de chacune des requ√™tes.

      ### 1. Cr√©er une entit√© op√©rateur

      Pour cr√©er une entit√© op√©rateur, vous devez contacter l'√©quipe du Registre
      de preuve de covoiturage qui vous ouvrira un acc√®s √† l'application :
      [contact@covoiturage.beta.gouv.fr](mailto:contact@covoiturage.beta.gouv.fr)

      ### 2. Cr√©er un utilisateur administrateur

      L'√©quipe du Registre de preuve de covoiturage vous donnera les droits
      d'administrateur sur l'entit√© op√©rateur et le premier utilisateur sera
      administrateur. Vous pouvez inviter des collaborateurs avec des r√¥les
      diff√©rents par la suite.

      ### 3. Cr√©er un token applicatif

      Depuis l'interface de l'application RPC, l'administrateur peut cr√©er un
      token applicatif qui sera utilis√© pour authentifier les requ√™tes HTTP.

      - [Cr√©er un nouveau token applicatif](https://app.covoiturage.beta.gouv.fr/admin/api)

      > info
      > Ce token ne pourra pas √™tre r√©-affich√© ni r√©cup√©r√©. Si le token est
      > perdu, il doit √™tre recr√©√© par la m√™me proc√©dure.

      ### 4. Utiliser le token

      Le token est un _bearer token_ qui doit √™tre pass√© dans le Header de
      chaque requ√™te HTTP :

      ```
      Authorization: Bearer {token}
      ```

      Il est au format JWT et contient des informations sur l'op√©rateur et les
      permissions associ√©es. Le token est sign√© par le serveur du Registre qui
      v√©rifie son authenticit√©. Il a une dur√©e de vie longue mais il est
      recommand√© de le changer r√©guli√®rement.
  - title: Rate limiting
    content: |
      Nous appliquons une limite au nombre de requ√™tes HTTP qui peuvent
      √™tre effectu√©es dans une p√©riode donn√©e. Lorsque cette limite est
      atteinte, notre API renverra une erreur `429 Too Many Requests`.

      Chaque type de route a une limite de requ√™tes diff√©rente. La limite
      pour l'envoi des trajets est de 20000 requ√™tes par minute.

      Les en-t√™tes suivants sont envoy√©s avec chaque r√©ponse :

      - `RateLimit-Limit` : nombre total de requ√™tes entre deux r√©initialisations de quota ;
      - `RateLimit-Remaining` : nombre de requ√™tes jusqu'√† la r√©initialisation du quota ;
      - `RateLimit-Reset` : temps restant (en secondes) jusqu'√† la r√©initialisation du quota.
  - title: Demandes CEE
    content: |
      ## Pr√©sentation

      Dans le cadre des fiches standardis√©es et bonifi√©es pour le covoiturage
      courte et longue distance, le RPC de preuve de covoiturage met √†
      disposition des op√©rateurs de covoiturage, une API (Application
      Programming Interface permettant √† ces derniers de v√©rifier en partie
      l'√©ligibilit√© d'un dossier de demande CEE (v√©rification de l'historique et
      du d√©doublonnage) et de r√©colter des donn√©es du RPC n√©cessaires √† la bonne
      constitution du dossier avant envoi de celui-ci par l'op√©rateur de
      covoiturage au PNCEE.

      Cette API a pour but de fluidifier et de fiabiliser les demandes de
      dossier afin d'√©viter un maximum de refus de ces derniers par le PNCEE en
      cas de doublon par exemple.

      ## Ressources utiles

      - [Arr√™t√© de cr√©ation des op√©rations standardis√©es CEE covoiturage (fonctionnement non bonifi√©)](https://www.legifrance.gouv.fr/jorf/id/JORFSCTA000046374229)
      - Arr√™t√© de cr√©ation de la bonification : en cours

      ## Objectifs

      - v√©rification de l'√©ligibilit√© d'un usager √† l'op√©ration standardis√©e :
          - v√©rification de l'historique : invalidation des usagers ayant d√©j√† b√©n√©fici√© d'op√©rations sp√©cifiques 3 ans avant la r√©alisation du trajet. Comparatif sur la base des donn√©es transmises par les op√©rateurs
          - v√©rification d√©doublonnage : invalidation des usagers ayant d√©j√† b√©n√©fici√© de l'op√©ration standardis√©e quelque soit la plateforme de covoiturage utilis√©e.
      - confirmation de l'√©ligibilit√© et mise √† disposition d'√©l√©ments constitutifs du dossier de demande de prime
          - transmission des √©l√©ments suivants : journey_id; status et token (signature RPC)

      ## V√©rifier un token

      Pour v√©rifier le token, il faut disposer des informations suivantes :

      - SIRET de l'op√©rateur ;
      - type de trajet (short ou long) ;
      - num√©ro de permis de conduire ;
      - horodatage au format _ISO 8601 UTC_ (ex: `2022-11-22T08:54:19Z`).

      Ces informations sont utilis√©es pour former une cha√Æne de caract√®res comme
      suit `siret/type/permis/horadatage`,
      exemple : `13002526500013/short/051227308989/2022-11-22T08:54:19Z`. Cette
      cha√Æne est hach√©e via un SHA512 et constitue le message.

      Ce message est sign√© via une cl√© RSA et peut donc √™tre v√©rifi√© avec la cl√©
      publique du Registre ci-apr√®s :

      ```
      -----BEGIN PUBLIC KEY-----
      MIICIDANBgkqhkiG9w0BAQEFAAOCAg0AMIICCAKCAgEA0m019dxJhmGl9XKCEBxl
      fgfKkmsre3KXlAkgan34k1vPyBuc1vz+3IQPuVrnEABghaSG8E7FpZ1DV913bWQ+
      0MTnnr801ZeE23wFYFlmpTfoOY7e89rvekLgB4oA1kisc28a5VAkGY+VggzGB9x+
      gWd82+LloPbzd1CgR3atNYXjPdQLqtEA1g6Pmj0eUNfSSr5SFUFlzmAhJyK0uUM4
      O/PKQFVBDqbrUU4fwhWJum6awmVc9G7OMUneOmu0wCl949U+Ek7VIstZpfmz3+JU
      4lMQ+9CU5OHR461WpyfC64cBcS9RbMflqivQGWMKoGgOBchVAB8vMn47ni66T5cV
      1SrKOe5IEbb4vEcHA5d1e5VwpCV4aoIRIQNzos/PO9rXOT3osTJV3wylQxIu2+5j
      yKDv0/mIKG+0HPt9fORA2TwqYZ0QEaBd8eCpgKHeKTZeAe15y1PKRUZuPKji1DL3
      1ceMIJY5iCvjMi5fwzD3rD20a1ttKvYRtqNFzYaVpmnxhnysSPUJp99KDZh6HO9g
      vfmzoi/adJ46P5+WEbOnfBO31+yKd6nnX4p7XM1F6vkDw6RXj9dE/SOKtfAljySO
      vMq3Z5rUJEjjZzYrnNkooqAXtzhp4Tl/i4t1n2XFS3pqu2vqjtDQ9+cRt6Fv8Wsx
      7Ul3uRRHi8Nb63mjjmRmd2MCAQM=
      -----END PUBLIC KEY-----
      ```

      ## Technique de d√©doublonnage

      Le processus de d√©doublonnage permet d'identifier les b√©n√©ficiaires
      potentiellement en double dans la base de donn√©es. Il s'appuie sur
      plusieurs crit√®res pour comparer les enregistrements et d√©terminer s'ils
      correspondent √† la m√™me personne.

      L'algorithme de d√©doublonnage fonctionne de la mani√®re suivante. Si l'un
      des champs suivants est similaire avec un enregistrement existant, la
      tentative d'enregistrement est consid√©r√© comme un doublon.

      - Permis de conduire (`driver_license`): Le num√©ro de permis de conduire est un identifiant unique qui permet de d√©doublonner les b√©n√©ficiaires avec certitude.
      - Cl√© d'identit√© (`identity_key`): Si la cl√© d'identit√© est d√©finie pour un b√©n√©ficiaire, elle est utilis√©e pour le d√©doublonner de mani√®re unique.
      - Nom tronqu√© et num√©ro de t√©l√©phone tronqu√© (`phone_trunc` & `last_name_trunc`): Cette combinaison permet de d√©tecter les b√©n√©ficiaires dont les noms et les num√©ros de t√©l√©phone sont similaires, m√™me si l'orthographe exacte peut varier. Cette combinaison n'est utilis√©e que sur les enregistrements pass√©s qui n'ont pas de cl√© d'identit√©.

      Cette correspondance est faite de mani√®re distincte sur la courte et la
      longue distance. Elle est √©galement limit√©e dans le temps √† la date de
      l'enregistrement qui a eu une correspondance en fonction de la nature de
      l'op√©ration (sp√©cifique ou standardis√©e).
  - title: Export de trajets
    content: |
      ## Schema d'export des trajets v3.1

      Les trajets sont export√©s au format CSV (s√©parateur : `,`) et compress√©s au
      format ZIP.

      Le üîí indique que ces donn√©es ne sont pas pr√©sentes dans l'export Open data.

      ### Trajet

      | Colonne                       | Explications                                                                                                                                                                                                                  |
      | ----------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
      | `journey_id`                  | Identifiant RPC d'un couple passager/conducteur                                                                                                                                                                               |
      | `operator_trip_id`&nbsp;üîí    | Identifiant op√©rateur permettant de regrouper plusieurs couples au sein d'un m√™me trajet                                                                                                                                      |
      | `operator_journey_id`&nbsp;üîí | Identifiant op√©rateur d'un couple passager/conducteur                                                                                                                                                                         |
      | `operator_class`              | La classe de preuve correspondant aux sp√©cifications d√©finies dans [Classes de preuve de covoiturage](https://doc.covoiturage.beta.gouv.fr/le-registre-de-preuve-de-covoiturage/classes-de-preuve-and-identite/classes-a-b-c) |
      | `operator`&nbsp;üîí            | Nom de l'op√©rateur                                                                                                                                                                                                            |
      | `status`                      | Statut du trajet pour le RPC                                                                                                                                                                                                  |

      ### Dates et heures

      | Colonne          | Explications                                                                                 |
      | ---------------- | -------------------------------------------------------------------------------------------- |
      | `start_datetime` | Date et heure locale du d√©part au format ISO 8601 (YYYY-MM-DDThh:mm:ss). Plage de 10 minutes |
      | `start_date`     | Date locale du d√©part au format ISO 8601 (YYYY-MM-DD)                                        |
      | `start_time`     | Heure locale du d√©part au format Thh:mm:ss). Plage de 10 minutes                             |
      |                  |                                                                                              |
      | `end_datetime`   | Date et heure locale d'arriv√©e au format ISO 8601 (YYYY-MM-DDThh:mm:ss). Plage de 10 minutes |
      | `end_date`       | Date locale d'arriv√©e au format ISO 8601 (YYYY-MM-DD)                                        |
      | `end_time`       | Heure locale d'arriv√©e au format Thh:mm:ss). Plage de 10 minutes                             |
      |                  |                                                                                              |
      | `duration`       | Dur√©e indicative du trajet (HH:MM:SS) calcul√©e par le RPC                                    |

      > Les dates et heures sont exprim√©es dans le fuseau horaire `Europe/Paris`.

      ### Lieux

      | Colonne             | Explications                                                                                                                           |
      | ------------------- | -------------------------------------------------------------------------------------------------------------------------------------- |
      | `distance`          | Distance covoitur√©e en kilom√®tres (pr√©cision au m√®tre)                                                                                 |
      |                     |                                                                                                                                        |
      | `start_lat`         | Latitude comprise entre 90deg et -90deg d√©cimaux en datum WSG-84 Pr√©cision √† 3 d√©cimales zone dense et 2 d√©cimales en zone peu dense   |
      | `start_lon`         | Longitude comprise entre 180deg et -90deg d√©cimaux en datum WSG-84 Pr√©cision √† 3 d√©cimales zone dense et 2 d√©cimales en zone peu dense |
      | `end_lat`           | Latitude comprise entre 90deg et -90deg d√©cimaux en datum WSG-84 Pr√©cision √† 3 d√©cimales zone dense et 2 d√©cimales en zone peu dense   |
      | `end_lon`           | Longitude comprise entre 180deg et -90deg d√©cimaux en datum WSG-84 Pr√©cision √† 3 d√©cimales zone dense et 2 d√©cimales en zone peu dense |
      |                     |                                                                                                                                        |
      | `start_insee`       | Code INSEE commune ou arrondissement de la position de d√©part                                                                          |
      | `start_commune`     | Nom commune de d√©part                                                                                                                  |
      | `start_departement` | Nom du d√©partement de la position de d√©part                                                                                            |
      | `start_epci`        | EPCI de d√©part                                                                                                                         |
      | `start_aom`         | AOM de d√©part                                                                                                                          |
      | `start_region`      | Nom de la r√©gion de d√©part                                                                                                             |
      | `start_pays`        | Nom du pays de d√©part                                                                                                                  |
      | `end_insee`         | Code INSEE commune ou arrondissement de la position d'arriv√©e                                                                          |
      | `end_commune`       | Nom commune d'arriv√©e                                                                                                                  |
      | `end_departement`   | Nom du d√©partement de la position d'arriv√©e                                                                                            |
      | `end_epci`          | EPCI d'arriv√©e                                                                                                                         |
      | `end_aom`           | AOM d'arriv√©e                                                                                                                          |
      | `end_region`        | Nom de la r√©gion d'arriv√©e                                                                                                             |
      | `end_pays`          | Nom du pays d'arriv√©e                                                                                                                  |

      ### Participants

      | Colonne                          | Explications                                                  |
      | -------------------------------- | ------------------------------------------------------------- |
      | `passenger_seats`                | Nombre de si√®ges r√©serv√©s par l'occupant passager. D√©faut : 1 |
      |                                  |                                                               |
      | `operator_passenger_id`&nbsp;üîí  | identifiant op√©rateur du passager                             |
      | `passenger_identity_key`&nbsp;üîí | identifiant unique inter-op√©rateur du passager                |
      | `operator_driver_id`&nbsp;üîí     | identifiant op√©rateur du conducteur                           |
      | `driver_identity_key`&nbsp;üîí    | identifiant unique inter-op√©rateur du conducteur              |

      ### Subventions

      | Colonne                             | Explications                                                                                                                                                                                                                                          |
      | ----------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
      | `cee_application`                   | Lien avec un dossier CEE (Oui/Non)                                                                                                                                                                                                                    |
      |                                     |                                                                                                                                                                                                                                                       |
      | `driver_revenue`&nbsp;üîí            | La somme en ‚Ç¨ r√©ellement per√ßue par le conducteur APR√àS que toutes les incitations (subventions employeurs, promotions op√©rateurs, incitations AOM, etc.), contributions des passagers ont √©t√© vers√©es et que la commission de l'op√©rateur soit prise |
      | `passenger_contribution`&nbsp;üîí    | Co√ªt r√©el total en ‚Ç¨ du service pour l'occupant passager en fonction du nombre de si√®ges r√©serv√©s APR√àS que toutes les possibles incitations ont √©t√© vers√©es (subventions employeurs, promotions op√©rateurs, incitations AOM, etc)                    |
      | `incentive_type`                    | P√©riode \"normale\" ou \"booster\"                                                                                                                                                                                                                        |
      | `incentive\\_{N}\\_siret`             | SIRET de la contrepartie financi√®re N                                                                                                                                                                                                                 |
      | `incentive\\_{N}\\_name`              | Organisme distributeur                                                                                                                                                                                                                                |
      | `incentive\\_{N}\\_amount`            | Montant en ‚Ç¨ de la contrepartie financi√®re N                                                                                                                                                                                                          |
      | `incentive_rpc\\_{N}\\_campaign_id`   | ID de la campagne de la contrepartie financi√®re N calcul√©e par le RPC                                                                                                                                                                                 |
      | `incentive_rpc\\_{N}\\_campaign_name` | Nom de la campagne de la contrepartie financi√®re N calcul√©e par le RPC                                                                                                                                                                                |
      | `incentive_rpc\\_{N}\\_siret`         | SIRET du sponsor de la contrepartie financi√®re N calcul√©e par le RPC                                                                                                                                                                                  |
      | `incentive_rpc\\_{N}\\_name`          | Nom du sponsor de la contrepartie financi√®re N calcul√©e par le RPC                                                                                                                                                                                    |
      | `incentive_rpc\\_{N}\\_amount`        | Montant en ‚Ç¨ de la contrepartie financi√®re N calcul√©e par le RPC                                                                                                                                                                                      |

      ## Comparatif V2.0 / V3.x

      Tableau comparatif des colonnes entre les versions 2 et 3 de l'export des
      trajets.

      | V2.0                             | V3.x                          | Remarques sur la migration V2 -> V3                                            |
      | -------------------------------- | ----------------------------- | ------------------------------------------------------------------------------ |
      | `journey_id`                     | `journey_id`                  | Identifiant unique de couple passager/conducteur                               |
      | `trip_id`                        |                               | Identifiant de regroupement des couples g√©n√©r√© par le RPC                      |
      |                                  | `operator_trip_id`            | Identifiant de regroupement des couples g√©n√©r√© par l'op√©rateur                 |
      |                                  | `operator_journey_id`         | Identifiant de couple g√©n√©r√© par l'op√©rateur                                   |
      | `journey_start_datetime`         | `start_datetime`              | Passage en UTC                                                                 |
      | `journey_start_date`             | `start_date`                  | Passage en UTC                                                                 |
      | `journey_start_time`             | `start_time`                  | Passage en UTC                                                                 |
      | `journey_start_lon`              | `start_lon`                   |                                                                                |
      | `journey_start_lat`              | `start_lat`                   |                                                                                |
      | `journey_start_insee`            | `start_insee`                 |                                                                                |
      | `journey_start_department`       | `start_departement`           |                                                                                |
      | `journey_start_town`             | `start_commune`               |                                                                                |
      | `journey_start_towngroup`        | `start_epci`                  |                                                                                |
      | `journey_start_country`          | `start_pays`                  |                                                                                |
      | `journey_end_datetime`           | `end_datetime`                | Passage en UTC                                                                 |
      | `journey_end_date`               | `end_date`                    | Passage en UTC                                                                 |
      | `journey_end_time`               | `end_time`                    | Passage en UTC                                                                 |
      | `journey_end_lon`                | `end_lon`                     |                                                                                |
      | `journey_end_lat`                | `end_lat`                     |                                                                                |
      | `journey_end_insee`              | `end_insee`                   |                                                                                |
      | `journey_end_department`         | `end_departement`             |                                                                                |
      | `journey_end_town`               | `end_commune`                 |                                                                                |
      | `journey_end_towngroup`          | `end_epci`                    |                                                                                |
      | `journey_end_country`            | `end_pays`                    |                                                                                |
      | `driver_card`                    |                               |                                                                                |
      | `passenger_card`                 |                               |                                                                                |
      | `passenger_over_18`              |                               |                                                                                |
      | `passenger_seats`                | `passenger_seats`             |                                                                                |
      | `operator_class`                 | `operator_class`              |                                                                                |
      | `operator`                       | `operator`                    |                                                                                |
      | `journey_distance_anounced`      | `distance`                    | La distance envoy√©e par l'op√©rateur. Changement de format (m -> km)            |
      | `journey_distance_calculated`    |                               |                                                                                |
      | `journey_duration_anounced`      |                               |                                                                                |
      | `journey_duration_calculated`    | `duration`                    | La dur√©e indicative calcul√©e par le RPC. Changement de format (MM -> HH:MM:SS) |
      | `operator_passenger_id`          | `operator_passenger_id`       |                                                                                |
      |                                  | `passenger_identity_id`       | Identifiant personnel inter-op√©rateurs                                         |
      | `operator_driver_id`             | `operator_driver_id`          |                                                                                |
      |                                  | `driver_identity_key`         | Identifiant personnel inter-op√©rateurs                                         |
      | `status`                         | `status`                      | Statut du trajet : `acquisition_error`, `validation_error`, `normalization_error`, `fraud_error`, `anomaly_error`, `ok`, `expired`, `canceled`, `pending`, `unknown`                                                        |
      | `passenger_id`                   |                               |                                                                                |
      | `passenger_contribution`         | `passenger_contribution`      |                                                                                |
      | `passenger_incentive_N_siret`    |                               |                                                                                |
      | `passenger_incentive_N_amount`   |                               |                                                                                |
      | `passenger_incentive_rpc_N_siret`|                               |                                                                                |
      | `passenger_incentive_rpc_N_name` |                               |                                                                                |
      | `passenger_incentive_rpc_N_amount`|                              |                                                                                |
      | `driver_id`                      |                               |                                                                                |
      | `driver_revenue`                 | `driver_revenue`              |                                                                                |
      | `driver_incentive_N_siret`       |                               |                                                                                |
      | `driver_incentive_N_amount`      |                               |                                                                                |
      | `driver_incentive_rpc_N_siret`   |                               |                                                                                |
      | `driver_incentive_rpc_N_name`    |                               |                                                                                |
      | `driver_incentive_rpc_N_amount`  |                               |                                                                                |
      |                                  | `cee_application`             | Demande de dossier CEE (oui/non)                                               |
      |                                  | `incentive_type`              | Type d'incitation (normale/booster)                                            |
      |                                  | `incentive_N_siret`           | Incitation envoy√©e par l'op√©rateur : SIRET                                     |
      |                                  | `incentive_N_name`            | Incitation envoy√©e par l'op√©rateur : nom                                       |
      |                                  | `incentive_N_amount`          | Incitation envoy√©e par l'op√©rateur : montant en ‚Ç¨                              |
      |                                  | `incentive_rpc_N_campaign_id` | Incitation calcul√©e par le RPC : identifiant campagne                          |
      |                                  | `incentive_rpc_N_campaign_name`| Incitation calcul√©e par le RPC : nom de la campagne                            |
      |                                  | `incentive_rpc_N_siret`       | Incitation calcul√©e par le RPC : SIRET du sponsor                              |
      |                                  | `incentive_rpc_N_name`        | Incitation calcul√©e par le RPC : nom du sponsor                                |
      |                                  | `incentive_rpc_N_amount`      | Incitation calcul√©e par le RPC : montant en ‚Ç¨                                  |

  - title: Attestations op√©rateurs ‚ö†Ô∏è
    content: |
      > warn
      > Cette API sera d√©pr√©ci√©e en v3.2 et ne sera pas remplac√©e.

      > info
      > Cette page concerne les attestations fournies par les op√©rateurs de covoiturage.
      >
      > Rendez-vous sur [https://attestation.covoiturage.beta.gouv.fr/](http://attestation.covoiturage.beta.gouv.fr/) pour g√©n√©rer votre attestation sur l'honneur.

      Une attestation de covoiturage est un document retra√ßant les trajets d'une
      personne sur une dur√©e donn√©e. Cette attestation au format PDF imprimable
      A4 est produite √† la demande de l'utilisateur¬∑rice et au travers de la
      plateforme avec laquelle les trajets sont effectu√©s.

      Dans le cadre du Forfait Mobilit√©s Durables par exemple, l'attestation
      permet √† l'employeur de prendre en charge tout ou partie des frais engag√©s
      par l'employ√©¬∑e selon ses propres modes de calcul.

      ## √âtapes de g√©n√©ration d'une attestation PDF

      1. **Cr√©ation de l'attestation**
        Sur la base des donn√©es d'identit√© fournies, les donn√©es de trajet li√©es
        √† cette personne sont compil√©es et sauvegard√©es avec un identifiant
        unique qui permettra de r√©cup√©rer et v√©rifier l'attestation.
      2. **T√©l√©chargement du PDF**
        L'identifiant unique de l'attestation est utilis√© pour g√©n√©rer un PDF
        imprimable. Les donn√©es stock√©es lors de la cr√©ation de l'attestation
        sont mises en forme sur un document au format A4.

  - title: Open data
    content: |
      Les trajets r√©alis√©s en covoiturage sont disponibles en Open Data sur la
      [Plateforme ouverte des donn√©es publiques fran√ßaises (data.gouv.fr)](https://www.data.gouv.fr/fr/datasets/trajets-realises-en-covoiturage-registre-de-preuve-de-covoiturage/).

      Le jeu de donn√©es est mis √† jour chaque d√©but de mois et contient les trajets
      effectu√©s par les utilisateurs des plateformes de covoiturage partenaires
      du Registre de preuve de covoiturage.

      Afin de garantir la confidentialit√© des utilisateurs, les donn√©es sont anonymis√©es et filtr√©es selon les r√®gles suivantes :

      - Anonymisation des donn√©es via la suppression des identifitants conducteurs et passagers.
      - Application de tranches horaires : les heures de d√©parts et arriv√©es sont arrondis √† 10 minutes pr√®s.
      - Carroyage des donn√©es g√©ographiques :
        - Lorsque la densit√© du point de d√©part ou arriv√©e est faible : la latitude et longitude sont tronqu√©s √† 2 d√©cimales (pr√©cision de ~700m).
        - Lorsque la densit√© du point de d√©part ou arriv√©e est forte : la latitude et longitude sont tronqu√©s √† 3 d√©cimales (pr√©cision de ~70m).
      - Suppression des trajets aff√©rents √† une maille g√©ographique "solitaire" :
        - Si le nombre d'occurences du code INSEE de d√©part est < 6 sur le jeu de donn√©es, le trajet est supprim√©.
        - Si le nombre d'occurences du code INSEE d'arriv√©e est < 6 sur le jeu de donn√©es, le trajet est supprim√©.
